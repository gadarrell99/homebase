#!/bin/bash
cd "$(dirname "$0")/../.."

python3 << 'PYEOF'
import sqlite3
import subprocess
import re
from datetime import datetime, timedelta

DB = "data/uptime.db"
TIMESTAMP = datetime.utcnow().strftime("%Y-%m-%dT%H:%M:%SZ")

db = sqlite3.connect(DB)

# Server pings
SERVERS = [
    ("239", "premier-emr"), ("240", "helios"), ("241", "david"), ("243", "cobalt"),
    ("245", "claude-dev"), ("246", "bps-ai"), ("247", "nexus"), ("248", "relay"),
    ("249", "vector"), ("252", "dockyard"), ("253", "hyper-v")
]

for octet, sid in SERVERS:
    ip = f"192.168.65.{octet}"
    try:
        result = subprocess.run(["ping", "-c", "1", "-W", "2", ip], capture_output=True, text=True, timeout=5)
        if result.returncode == 0:
            match = re.search(r'time=([0-9.]+)', result.stdout)
            latency = float(match.group(1)) if match else None
            db.execute("INSERT INTO server_pings(server_id,timestamp,reachable,latency_ms) VALUES(?,?,1,?)",
                       (sid, TIMESTAMP, latency))
        else:
            db.execute("INSERT INTO server_pings(server_id,timestamp,reachable,latency_ms) VALUES(?,?,0,NULL)",
                       (sid, TIMESTAMP))
    except:
        db.execute("INSERT INTO server_pings(server_id,timestamp,reachable,latency_ms) VALUES(?,?,0,NULL)",
                   (sid, TIMESTAMP))

# Project HTTP checks
PROJECTS = [
    ("helios", "http://192.168.65.240:3800"),
    ("homebase", "http://localhost:8000"),
    ("bps-ai", "http://192.168.65.246:3000"),
    ("nexus", "http://192.168.65.247:3000"),
    ("relay", "http://192.168.65.248:8000"),
    ("vector", "http://192.168.65.249:3000"),
    ("dockyard", "http://192.168.65.252:3000"),
    ("premier-emr", "http://192.168.65.239:3000"),
    ("david", "http://192.168.65.241:5000")
]

for pid, url in PROJECTS:
    try:
        result = subprocess.run(
            ["curl", "-s", "-o", "/dev/null", "-w", "%{http_code}:%{time_total}", "--max-time", "5", url],
            capture_output=True, text=True, timeout=10
        )
        parts = result.stdout.strip().split(":")
        code = int(parts[0]) if parts[0].isdigit() else 0
        time_ms = float(parts[1]) * 1000 if len(parts) > 1 else None
        is_up = 1 if 200 <= code < 500 else 0
        db.execute("INSERT INTO project_checks(project_id,timestamp,http_code,response_ms,is_up) VALUES(?,?,?,?,?)",
                   (pid, TIMESTAMP, code, time_ms, is_up))
    except Exception as e:
        db.execute("INSERT INTO project_checks(project_id,timestamp,http_code,response_ms,is_up) VALUES(?,?,0,NULL,0)",
                   (pid, TIMESTAMP))

# Prune old data (keep 7 days)
cutoff = (datetime.utcnow() - timedelta(days=7)).strftime("%Y-%m-%dT%H:%M:%SZ")
db.execute("DELETE FROM server_pings WHERE timestamp < ?", (cutoff,))
db.execute("DELETE FROM project_checks WHERE timestamp < ?", (cutoff,))

db.commit()
db.close()
print("Uptime check complete")
PYEOF
