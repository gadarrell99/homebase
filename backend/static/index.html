<!DOCTYPE html>
<html lang="en">
<head>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè†</text></svg>">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homebase | Rize Infrastructure</title>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #e2e8f0; min-height: 100vh; }
.main-nav { display: flex; align-items: center; padding: 0.75rem 1.5rem; background: #1e293b; border-bottom: 1px solid #334155; position: sticky; top: 0; z-index: 100; }
.main-nav .logo { font-size: 1.1rem; font-weight: 600; color: #e2e8f0; margin-right: 2rem; text-decoration: none; }
.main-nav .nav-links { display: flex; gap: 0.25rem; flex: 1; flex-wrap: wrap; align-items: center; }
.main-nav .nav-links a { color: #94a3b8; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-size: 0.875rem; text-decoration: none; transition: all 0.15s; }
.main-nav .nav-links a:hover, .main-nav .nav-links a.active { color: #e2e8f0; background: #334155; }

a { color: #60a5fa; text-decoration: none; }
a:hover { color: #93c5fd; }

.page-container { padding: 1.5rem; max-width: 1400px; margin: 0 auto; }
.page-header { margin-bottom: 1.5rem; }
.page-header h1 { font-size: 1.75rem; font-weight: 600; margin-bottom: 0.25rem; }
.page-header p { color: #64748b; font-size: 0.875rem; }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
.stat-card { background: #1e293b; border: 1px solid #334155; border-radius: 0.5rem; padding: 1.25rem; }
.stat-card:hover { border-color: #475569; }
.stat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
.stat-label { color: #94a3b8; font-size: 0.875rem; }
.stat-value { font-size: 2rem; font-weight: 700; color: #e2e8f0; }
.stat-value.green { color: #4ade80; }
.stat-value.yellow { color: #fbbf24; }
.stat-value.red { color: #f87171; }
.stat-detail { font-size: 0.75rem; color: #64748b; margin-top: 0.5rem; }
.section { background: #1e293b; border: 1px solid #334155; border-radius: 0.5rem; padding: 1.25rem; margin-bottom: 1.5rem; }
.section h2 { font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: #f1f5f9; }
.server-row { display: flex; align-items: center; padding: 0.75rem; border-radius: 0.375rem; margin-bottom: 0.5rem; background: #0f172a; }
.server-row:hover { background: #1a1a2e; }
.server-icon { font-size: 1.25rem; margin-right: 0.75rem; }
.server-info { flex: 1; }
.server-name { font-weight: 500; font-size: 0.9rem; }
.server-ip { font-size: 0.75rem; color: #64748b; font-family: monospace; }
.server-status { padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.7rem; font-weight: 600; }
.status-ok { background: #166534; color: #86efac; }
.status-warn { background: #854d0e; color: #fcd34d; }
.status-error { background: #991b1b; color: #fca5a5; }
.alert-banner { background: #7f1d1d; border: 1px solid #991b1b; padding: 0.75rem 1rem; border-radius: 0.5rem; margin-bottom: 1rem; display: none; }
.alert-banner.show { display: block; }
.updated { font-size: 0.7rem; color: #475569; text-align: right; margin-top: 0.5rem; }
@media (max-width: 768px) { .page-container { padding: 1rem; } .stats-grid { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>
    <nav class="main-nav">
    <a href="/" class="logo">Homebase</a>
    <div class="nav-links">
        <a href="/" class="active">Dashboard</a>
        <a href="/fleet">Fleet</a>
        <a href="/agents">Agents</a>
        <a href="/sentinel">Sentinel</a>
        <a href="/cortex">Cortex</a>
        <a href="/research">Research</a>
        <a href="/infra">Infra Sheet</a>
        <a href="/settings">Settings</a>
        <a href="/backups">Backups</a>
        <a href="/requirements">Requirements</a>
        <a href="https://gitea.rize.bm" target="_blank">Gitea</a>
    </div>
</nav>

    <div class="page-container">
        <div class="page-header">
            <h1>Rize Infrastructure Dashboard</h1>
            <p>Real-time status from infrastructure.json</p>
        </div>

        <div id="alert-banner" class="alert-banner"></div>

        <div class="stats-grid">
            <a href="/servers" class="stat-card">
                <div class="stat-header"><span class="stat-label">Active Servers</span></div>
                <div class="stat-value green" id="server-count">-</div>
                <div class="stat-detail" id="server-detail">Loading...</div>
            </a>
            <a href="/projects" class="stat-card">
                <div class="stat-header"><span class="stat-label">Projects</span></div>
                <div class="stat-value" id="project-count">-</div>
                <div class="stat-detail" id="project-detail">Loading...</div>
            </a>
            <a href="/agents" class="stat-card">
                <div class="stat-header"><span class="stat-label">AI Agents</span></div>
                <div class="stat-value" id="agent-count">-</div>
                <div class="stat-detail" id="agent-detail">Loading...</div>
            </a>
            <a href="/sentinel" class="stat-card">
                <div class="stat-header"><span class="stat-label">Disk Alerts</span></div>
                <div class="stat-value" id="disk-alerts">-</div>
                <div class="stat-detail" id="disk-detail">Servers over 80%</div>
            </a>
        </div>

        <div class="section">
            <h2>Server Fleet Status</h2>
            <div id="server-list">Loading...</div>
            <div class="updated" id="last-updated"></div>
        </div>

        <div class="section">
            <h2>Recent Agent Activity</h2>
            <div id="agent-activity">Loading...</div>
        </div>
    </div>

    <script src="/static/cache-helper.js"></script>
<script>
    async function loadDashboard() {
        try {
            const res = await fetch('/api/infrastructure');
            const infra = await res.json();
            
            const servers = infra.servers || [];
            const projects = infra.projects || [];
            const agents = infra.agents || [];
            
            const activeServers = servers.filter(s => s.status === 'online');
            const diskAlerts = activeServers.filter(s => parseInt(s.live?.disk_pct || '0') > 80);
            const liveAgents = agents.filter(a => a.mode === 'live');
            
            // Stats
            document.getElementById('server-count').textContent = activeServers.length;
            document.getElementById('server-detail').textContent = activeServers.length + ' active, ' + (servers.length - activeServers.length) + ' decommissioned';
            
            document.getElementById('project-count').textContent = projects.length;
            document.getElementById('project-detail').textContent = 'Across ' + new Set(projects.map(p => p.server)).size + ' servers';
            
            document.getElementById('agent-count').textContent = agents.length;
            document.getElementById('agent-detail').textContent = liveAgents.length + ' live, ' + (agents.length - liveAgents.length) + ' mock/active';
            
            const diskEl = document.getElementById('disk-alerts');
            diskEl.textContent = diskAlerts.length;
            diskEl.className = 'stat-value ' + (diskAlerts.length > 0 ? 'red' : 'green');
            if (diskAlerts.length > 0) {
                document.getElementById('disk-detail').textContent = diskAlerts.map(s => s.hostname).join(', ');
            }
            
            // Alert banner
            if (diskAlerts.length > 0) {
                const banner = document.getElementById('alert-banner');
                banner.innerHTML = '‚ö†Ô∏è Disk alert: ' + diskAlerts.map(s => s.hostname + ' at ' + s.live?.disk_pct + '%').join(', ');
                banner.classList.add('show');
            }
            
            // Server list
            document.getElementById('server-list').innerHTML = activeServers.map(s => {
                const live = s.live || {};
                const statusClass = (live.status === 'ok' || s.status === 'online') ? 'status-ok' : 'status-warn';
                const diskPct = live.disk_pct || '-';
                const memUsed = live.mem_used || '-';
                const memTotal = live.mem_total || '-';
                
                return '<div class="server-row">' +
                    '<span class="server-icon">' + (s.icon || 'üíª') + '</span>' +
                    '<div class="server-info">' +
                    '<div class="server-name">' + s.hostname + '</div>' +
                    '<div class="server-ip">' + s.ip + ' | ' + (s.ssh_user || '-') + ' | Disk: ' + diskPct + '% | Mem: ' + memUsed + '/' + memTotal + 'MB</div>' +
                    '</div>' +
                    '<span class="server-status ' + statusClass + '">' + (live.status || 'online') + '</span>' +
                    '</div>';
            }).join('');
            
            // Agent activity
            document.getElementById('agent-activity').innerHTML = agents.map(a => {
                const modeClass = a.mode === 'live' ? 'status-ok' : (a.mode === 'mock' ? 'status-warn' : 'status-ok');
                const srv = servers.find(s => s.id === a.server) || {};
                return '<div class="server-row">' +
                    '<span class="server-icon">ü§ñ</span>' +
                    '<div class="server-info">' +
                    '<div class="server-name">' + a.name + '</div>' +
                    '<div class="server-ip">' + (srv.hostname || a.server) + ' | Channels: ' + (a.channels || []).join(', ') + '</div>' +
                    '</div>' +
                    '<span class="server-status ' + modeClass + '">' + a.mode.toUpperCase() + '</span>' +
                    '</div>';
            }).join('');
            
            // Updated timestamp
            if (infra.meta?.updated) {
                document.getElementById('last-updated').textContent = 'Last scan: ' + new Date(infra.meta.updated).toLocaleString();
            }
        } catch (e) {
            console.error('Dashboard load failed:', e);
        }
    }
    
    initCacheFirst('homebase_dashboard', 'server-list', loadDashboard, 60000);
    </script>
</body>
</html>