<!DOCTYPE html>
<html lang="en">
<head>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè†</text></svg>">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infra Sheet | Homebase</title>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #e2e8f0; min-height: 100vh; }
a { color: #60a5fa; text-decoration: none; }
a:hover { color: #93c5fd; }
.main-nav { display: flex; align-items: center; padding: 0.75rem 1.5rem; background: #1e293b; border-bottom: 1px solid #334155; position: sticky; top: 0; z-index: 100; }
.main-nav .logo { font-size: 1.1rem; font-weight: 600; color: #e2e8f0; margin-right: 2rem; text-decoration: none; }
.main-nav .nav-links { display: flex; gap: 0.25rem; flex: 1; flex-wrap: wrap; align-items: center; }
.main-nav .nav-links > a { color: #94a3b8; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-size: 0.875rem; text-decoration: none; transition: all 0.15s; }
.main-nav .nav-links > a:hover, .main-nav .nav-links > a.active { color: #e2e8f0; background: #334155; }
.nav-dropdown { position: relative; }
.nav-dropdown .dropdown-toggle { color: #94a3b8; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-size: 0.875rem; text-decoration: none; cursor: pointer; }
.nav-dropdown:hover .dropdown-toggle { color: #e2e8f0; background: #334155; }
.nav-dropdown .dropdown-menu { display: none; position: absolute; right: 0; top: 100%; background: #1e293b; border: 1px solid #334155; border-radius: 0.375rem; min-width: 120px; z-index: 200; }
.nav-dropdown:hover .dropdown-menu { display: block; }
.nav-dropdown .dropdown-menu a { display: block; padding: 0.5rem 0.75rem; color: #94a3b8; font-size: 0.875rem; }
.nav-dropdown .dropdown-menu a:hover { background: #334155; color: #e2e8f0; }
.page-container { padding: 1.5rem; max-width: 1400px; margin: 0 auto; }
.page-header { margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
.page-header h1 { font-size: 1.75rem; font-weight: 600; }
.page-header .meta { color: #64748b; font-size: 0.875rem; }
.section { background: #1e293b; border: 1px solid #334155; border-radius: 0.5rem; margin-bottom: 1rem; overflow: hidden; }
.section-header { display: flex; align-items: center; padding: 1rem; cursor: pointer; background: #0f172a; border-bottom: 1px solid #334155; }
.section-header:hover { background: #1a1a2e; }
.section-header .arrow { margin-right: 0.75rem; transition: transform 0.2s; color: #64748b; }
.section-header.open .arrow { transform: rotate(90deg); }
.section-header h2 { font-size: 1rem; font-weight: 600; flex: 1; }
.section-body { display: none; padding: 1rem; }
.section-body.open { display: block; }
table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
th, td { padding: 0.5rem 0.75rem; text-align: left; border-bottom: 1px solid #334155; }
th { color: #94a3b8; font-weight: 500; background: #0f172a; }
td { color: #e2e8f0; }
tr:hover td { background: #1a1a2e; }
.mono { font-family: monospace; font-size: 0.8rem; }
.status-badge { display: inline-block; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.7rem; font-weight: 600; }
.status-online { background: #166534; color: #86efac; }
.status-live { background: #166534; color: #86efac; }
.status-mock { background: #854d0e; color: #fcd34d; }
.status-active { background: #1e40af; color: #93c5fd; }
.status-decom { background: #374151; color: #9ca3af; }
.cred-value { font-family: monospace; cursor: pointer; padding: 0.25rem 0.5rem; background: #0f172a; border-radius: 0.25rem; }
.cred-value.hidden::after { content: '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'; }
.cred-value.visible { color: #4ade80; }
.show-btn { background: none; border: 1px solid #334155; color: #94a3b8; padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.7rem; margin-left: 0.5rem; }
.show-btn:hover { background: #334155; color: #e2e8f0; }
.updated { font-size: 0.7rem; color: #475569; text-align: right; margin-top: 1rem; }
@media (max-width: 768px) { .page-container { padding: 1rem; } table { font-size: 0.75rem; } }
    </style>
</head>
<body>
    <nav class="main-nav">
        <a href="/" class="logo">Homebase</a>
        <div class="nav-links">
            <a href="/">Dashboard</a>
            <a href="/fleet">Fleet</a>
            <a href="/agents">Agents</a>
            <a href="/sentinel">Sentinel</a>
            <a href="/research">Research</a>
            <a href="/infra" class="active">Infra Sheet</a>
            <div class="nav-dropdown">
                <a href="#" class="dropdown-toggle">‚öôÔ∏è</a>
                <div class="dropdown-menu">
                    <a href="/settings">Settings</a>
                    <a href="/backups">Backups</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="page-container">
        <div class="page-header">
            <h1>Infrastructure Sheet</h1>
            <span class="meta" id="last-updated">Loading...</span>
        </div>

        <!-- Fleet Topology -->
        <div class="section">
            <div class="section-header open" onclick="toggleSection(this)">
                <span class="arrow">‚ñ∏</span>
                <h2>Fleet Topology</h2>
            </div>
            <div class="section-body open" id="fleet-topology"></div>
        </div>

        <!-- Port Map -->
        <div class="section">
            <div class="section-header open" onclick="toggleSection(this)">
                <span class="arrow">‚ñ∏</span>
                <h2>Port Map</h2>
            </div>
            <div class="section-body open" id="port-map"></div>
        </div>

        <!-- AI Agents -->
        <div class="section">
            <div class="section-header open" onclick="toggleSection(this)">
                <span class="arrow">‚ñ∏</span>
                <h2>AI Agents</h2>
            </div>
            <div class="section-body open" id="agents-section"></div>
        </div>

        <!-- DNS & Tunnels -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <span class="arrow">‚ñ∏</span>
                <h2>DNS & Tunnels</h2>
            </div>
            <div class="section-body" id="dns-tunnels"></div>
        </div>

        <!-- Credentials -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <span class="arrow">‚ñ∏</span>
                <h2>Credentials üîí</h2>
            </div>
            <div class="section-body" id="credentials-section"></div>
        </div>

        <!-- Automation -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <span class="arrow">‚ñ∏</span>
                <h2>Automation Pipeline</h2>
            </div>
            <div class="section-body" id="automation-section"></div>
        </div>

        <div class="updated" id="footer-updated"></div>
    </div>

    <script>
    function toggleSection(header) {
        header.classList.toggle('open');
        header.nextElementSibling.classList.toggle('open');
    }
    
    function toggleCred(el) {
        el.classList.toggle('hidden');
        el.classList.toggle('visible');
        if (el.classList.contains('visible')) {
            el.textContent = el.dataset.value;
        } else {
            el.textContent = '';
        }
    }
    
    async function loadInfra() {
        try {
            const res = await fetch('/api/infrastructure');
            const data = await res.json();
            
            // Fleet Topology
            const servers = data.servers || [];
            const fleetHtml = `
                <table>
                    <tr><th>Server</th><th>IP</th><th>User</th><th>Role</th><th>Status</th></tr>
                    ${servers.map(s => `
                        <tr>
                            <td>${s.icon || 'üíª'} ${s.hostname}</td>
                            <td class="mono">.${s.ip.split('.').pop()}</td>
                            <td class="mono">${s.ssh_user}</td>
                            <td>${s.role || '-'}</td>
                            <td><span class="status-badge status-${s.status === 'online' ? 'online' : 'decom'}">${s.status?.toUpperCase()}</span></td>
                        </tr>
                    `).join('')}
                </table>
            `;
            document.getElementById('fleet-topology').innerHTML = fleetHtml;
            
            // Port Map
            const projects = data.projects || [];
            const portHtml = `
                <table>
                    <tr><th>Port</th><th>Service</th><th>Server</th><th>Status</th></tr>
                    ${projects.filter(p => p.port || (p.ports && p.ports.length)).map(p => {
                        const ports = p.ports || [p.port];
                        const srv = servers.find(s => s.id === p.server) || {};
                        return ports.map(port => `
                            <tr>
                                <td class="mono">${port}</td>
                                <td>${p.name}</td>
                                <td>${srv.hostname || p.server}</td>
                                <td><span class="status-badge status-${p.status === 'running' ? 'online' : 'mock'}">${p.status?.toUpperCase() || 'UNKNOWN'}</span></td>
                            </tr>
                        `).join('');
                    }).join('')}
                </table>
            `;
            document.getElementById('port-map').innerHTML = portHtml;
            
            // AI Agents
            const agents = data.agents || [];
            const agentsHtml = `
                <table>
                    <tr><th>Agent</th><th>Port</th><th>Server</th><th>Mode</th><th>Channels</th></tr>
                    ${agents.filter(a => a.type !== 'cli_persona').map(a => {
                        const srv = servers.find(s => s.id === a.server) || {};
                        return `
                            <tr>
                                <td>ü§ñ ${a.name}</td>
                                <td class="mono">${a.port || '-'}</td>
                                <td>${srv.hostname || a.server}</td>
                                <td><span class="status-badge status-${a.mode}">${a.mode?.toUpperCase()}</span></td>
                                <td>${(a.channels || []).join(', ') || '-'}</td>
                            </tr>
                        `;
                    }).join('')}
                </table>
            `;
            document.getElementById('agents-section').innerHTML = agentsHtml;
            
            // DNS & Tunnels
            const domains = data.domains || [];
            const dnsHtml = domains.length ? `
                <table>
                    <tr><th>Domain</th><th>Target</th><th>Tunnel UUID</th></tr>
                    ${domains.map(d => `
                        <tr>
                            <td>${d.domain}</td>
                            <td class="mono">${d.target}</td>
                            <td class="mono">${d.tunnel_uuid ? d.tunnel_uuid.slice(0, 12) + '...' : '-'}</td>
                        </tr>
                    `).join('')}
                </table>
            ` : '<p style="color:#64748b">No domain records in infrastructure.json</p>';
            document.getElementById('dns-tunnels').innerHTML = dnsHtml;
            
            // Credentials
            const creds = data.credentials || {};
            const demoLogins = creds.demo_logins || [];
            const credsHtml = demoLogins.length ? `
                <table>
                    <tr><th>Service</th><th>User</th><th>Password</th></tr>
                    ${demoLogins.map(c => `
                        <tr>
                            <td>${c.service}</td>
                            <td class="mono">${c.username}</td>
                            <td>
                                <span class="cred-value hidden" data-value="${c.password}" onclick="toggleCred(this)"></span>
                                <button class="show-btn" onclick="toggleCred(this.previousElementSibling)">üëÅÔ∏è Show</button>
                            </td>
                        </tr>
                    `).join('')}
                </table>
            ` : '<p style="color:#64748b">No demo credentials configured</p>';
            document.getElementById('credentials-section').innerHTML = credsHtml;
            
            // Automation
            const auto = data.automation || {};
            const pipelines = auto.pipelines || [];
            const autoHtml = pipelines.length ? `
                <table>
                    <tr><th>Component</th><th>Owner</th><th>Schedule</th><th>Status</th></tr>
                    ${pipelines.map(p => `
                        <tr>
                            <td>${p.name}</td>
                            <td>${p.owner}</td>
                            <td>${p.schedule}</td>
                            <td><span class="status-badge status-${p.status === 'running' ? 'online' : 'active'}">${p.status?.toUpperCase()}</span></td>
                        </tr>
                    `).join('')}
                </table>
            ` : '<p style="color:#64748b">No automation pipelines configured</p>';
            document.getElementById('automation-section').innerHTML = autoHtml;
            
            // Timestamp
            const updated = data.meta?.updated ? new Date(data.meta.updated).toLocaleString() : new Date().toLocaleString();
            document.getElementById('last-updated').textContent = 'Last updated: ' + updated;
            document.getElementById('footer-updated').textContent = 'Data from infrastructure.json | ' + updated;
        } catch (e) {
            console.error('Infra load failed:', e);
        }
    }
    
    loadInfra();
    setInterval(loadInfra, 120000);
    </script>
</body>
</html>
