<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Mind Map â€” Homebase</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: #0a0e1a;
    color: #e2e8f0;
    font-family: 'Outfit', sans-serif;
    overflow: hidden;
    height: 100vh;
    width: 100vw;
  }
.main-nav { display: flex; align-items: center; padding: 0.75rem 1.5rem; background: #1e293b; border-bottom: 1px solid #334155; position: fixed; top: 0; left: 0; right: 0; z-index: 200; }
.main-nav .logo { font-size: 1.1rem; font-weight: 600; color: #e2e8f0; margin-right: 2rem; text-decoration: none; }
.main-nav .nav-links { display: flex; gap: 0.25rem; flex: 1; flex-wrap: wrap; align-items: center; }
.main-nav .nav-links a { color: #94a3b8; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-size: 0.875rem; text-decoration: none; transition: all 0.15s; }
.main-nav .nav-links a:hover, .main-nav .nav-links a.active { color: #e2e8f0; background: #334155; }

  #canvas-container {
    position: relative;
    width: 100%;
    height: calc(100vh - 56px);
    margin-top: 56px;
    overflow: hidden;
    cursor: grab;
  }
  #canvas-container:active { cursor: grabbing; }

  #canvas {
    position: absolute;
    transform-origin: 0 0;
    will-change: transform;
  }

  svg#connections {
    position: absolute;
    top: 0; left: 0;
    width: 5000px;
    height: 5000px;
    pointer-events: none;
    z-index: 1;
  }

  .node {
    position: absolute;
    border-radius: 16px;
    padding: 20px 24px;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    z-index: 10;
    min-width: 200px;
    backdrop-filter: blur(12px);
  }
  .node:hover {
    transform: scale(1.04);
    z-index: 20;
  }

  /* Server nodes - larger */
  .node-server {
    min-width: 240px;
    border-radius: 12px;
    padding: 24px 28px;
  }
  .node-server .node-header { margin-bottom: 12px; }
  .node-server .node-name { font-size: 1.1rem; }

  /* Server color variants */
  .node-server-talos {
    background: linear-gradient(135deg, rgba(167,139,250,0.25), rgba(139,92,246,0.15));
    border: 3px solid rgba(167,139,250,0.7);
    box-shadow: 0 0 40px rgba(167,139,250,0.2), inset 0 1px 0 rgba(255,255,255,0.05);
  }
  .node-server-talos:hover { box-shadow: 0 0 60px rgba(167,139,250,0.35); }

  .node-server-agents {
    background: linear-gradient(135deg, rgba(96,165,250,0.25), rgba(59,130,246,0.15));
    border: 3px solid rgba(96,165,250,0.7);
    box-shadow: 0 0 40px rgba(96,165,250,0.2), inset 0 1px 0 rgba(255,255,255,0.05);
  }
  .node-server-agents:hover { box-shadow: 0 0 60px rgba(96,165,250,0.35); }

  .node-server-rizeapps {
    background: linear-gradient(135deg, rgba(74,222,128,0.25), rgba(34,197,94,0.15));
    border: 3px solid rgba(74,222,128,0.7);
    box-shadow: 0 0 40px rgba(74,222,128,0.2), inset 0 1px 0 rgba(255,255,255,0.05);
  }
  .node-server-rizeapps:hover { box-shadow: 0 0 60px rgba(74,222,128,0.35); }

  .node-server-demos {
    background: linear-gradient(135deg, rgba(251,191,36,0.25), rgba(245,158,11,0.15));
    border: 3px solid rgba(251,191,36,0.7);
    box-shadow: 0 0 40px rgba(251,191,36,0.2), inset 0 1px 0 rgba(255,255,255,0.05);
  }
  .node-server-demos:hover { box-shadow: 0 0 60px rgba(251,191,36,0.35); }

  .node-server-vector {
    background: linear-gradient(135deg, rgba(248,113,113,0.25), rgba(239,68,68,0.15));
    border: 3px solid rgba(248,113,113,0.7);
    box-shadow: 0 0 40px rgba(248,113,113,0.2), inset 0 1px 0 rgba(255,255,255,0.05);
  }
  .node-server-vector:hover { box-shadow: 0 0 60px rgba(248,113,113,0.35); }

  /* Node types */
  .node-c2 {
    background: linear-gradient(135deg, rgba(59,130,246,0.25), rgba(99,102,241,0.15));
    border: 2px solid rgba(99,102,241,0.6);
    box-shadow: 0 0 30px rgba(99,102,241,0.15), inset 0 1px 0 rgba(255,255,255,0.05);
  }
  .node-c2:hover { box-shadow: 0 0 50px rgba(99,102,241,0.3); }

  .node-agent {
    background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(5,150,105,0.1));
    border: 2px solid rgba(16,185,129,0.5);
    box-shadow: 0 0 25px rgba(16,185,129,0.1), inset 0 1px 0 rgba(255,255,255,0.05);
  }
  .node-agent:hover { box-shadow: 0 0 45px rgba(16,185,129,0.25); }

  .node-oversight {
    background: linear-gradient(135deg, rgba(245,158,11,0.2), rgba(217,119,6,0.1));
    border: 2px solid rgba(245,158,11,0.5);
    box-shadow: 0 0 25px rgba(245,158,11,0.1), inset 0 1px 0 rgba(255,255,255,0.05);
  }
  .node-oversight:hover { box-shadow: 0 0 45px rgba(245,158,11,0.25); }

  .node-platform {
    background: linear-gradient(135deg, rgba(168,85,247,0.2), rgba(139,92,246,0.1));
    border: 2px solid rgba(168,85,247,0.45);
    box-shadow: 0 0 25px rgba(168,85,247,0.1), inset 0 1px 0 rgba(255,255,255,0.05);
  }
  .node-platform:hover { box-shadow: 0 0 45px rgba(168,85,247,0.25); }

  .node-demo {
    background: linear-gradient(135deg, rgba(236,72,153,0.2), rgba(219,39,119,0.1));
    border: 2px solid rgba(236,72,153,0.45);
    box-shadow: 0 0 25px rgba(236,72,153,0.1), inset 0 1px 0 rgba(255,255,255,0.05);
  }
  .node-demo:hover { box-shadow: 0 0 45px rgba(236,72,153,0.25); }

  .node-script {
    background: linear-gradient(135deg, rgba(34,211,238,0.15), rgba(6,182,212,0.08));
    border: 2px dashed rgba(34,211,238,0.45);
    box-shadow: 0 0 20px rgba(34,211,238,0.08), inset 0 1px 0 rgba(255,255,255,0.03);
  }
  .node-script:hover { box-shadow: 0 0 40px rgba(34,211,238,0.2); }

  .node.dragging {
    transform: scale(1.08);
    box-shadow: 0 20px 40px rgba(0,0,0,0.4), 0 0 60px rgba(99,102,241,0.3);
    z-index: 100 !important;
    cursor: grabbing;
    transition: none;
  }
  .node { cursor: grab; user-select: none; }

  .node-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
  }
  .node-icon {
    font-size: 1.5rem;
    line-height: 1;
  }
  .node-name {
    font-weight: 600;
    font-size: 1rem;
    letter-spacing: 0.02em;
  }
  .node-role {
    font-size: 0.75rem;
    color: #94a3b8;
    font-family: 'JetBrains Mono', monospace;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    margin-bottom: 6px;
  }
  .node-detail {
    font-size: 0.8rem;
    color: #cbd5e1;
    line-height: 1.5;
  }
  .node-server-info {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem;
    color: #64748b;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid rgba(255,255,255,0.06);
  }
  .node-ip {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    color: #e2e8f0;
    background: rgba(0,0,0,0.2);
    padding: 2px 6px;
    border-radius: 4px;
    margin-left: 8px;
  }
  .node-status {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.65rem;
    font-weight: 500;
    font-family: 'JetBrains Mono', monospace;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  .status-live { background: rgba(16,185,129,0.2); color: #34d399; }
  .status-readonly { background: rgba(245,158,11,0.2); color: #fbbf24; }
  .status-planned { background: rgba(99,102,241,0.2); color: #818cf8; }
  .status-active { background: rgba(59,130,246,0.2); color: #60a5fa; }
  .status-critical { background: rgba(239,68,68,0.3); color: #fca5a5; }

  /* Detail panel */
  #detail-panel {
    position: fixed;
    right: -420px;
    top: 56px;
    width: 400px;
    height: calc(100vh - 56px);
    background: rgba(15,23,42,0.97);
    border-left: 1px solid rgba(255,255,255,0.08);
    backdrop-filter: blur(20px);
    z-index: 100;
    transition: right 0.35s cubic-bezier(0.4,0,0.2,1);
    overflow-y: auto;
    padding: 32px 24px;
  }
  #detail-panel.open { right: 0; }
  #detail-panel h2 {
    font-size: 1.3rem;
    font-weight: 600;
    margin-bottom: 4px;
  }
  #detail-panel .detail-role {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    margin-bottom: 20px;
  }
  #detail-panel .detail-section {
    margin-bottom: 20px;
  }
  #detail-panel .detail-section h3 {
    font-size: 0.7rem;
    font-weight: 600;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 8px;
  }
  #detail-panel .detail-section p,
  #detail-panel .detail-section li {
    font-size: 0.85rem;
    color: #cbd5e1;
    line-height: 1.6;
  }
  #detail-panel ul { list-style: none; padding: 0; }
  #detail-panel li::before {
    content: 'â€º';
    color: #6366f1;
    margin-right: 8px;
    font-weight: 700;
  }
  #close-panel {
    position: absolute;
    top: 16px; right: 16px;
    background: none; border: none;
    color: #64748b; font-size: 1.4rem;
    cursor: pointer;
    transition: color 0.2s;
  }
  #close-panel:hover { color: #e2e8f0; }

  /* Header bar */
  #header {
    position: fixed;
    top: 56px; left: 0; right: 0;
    height: 56px;
    background: rgba(10,14,26,0.9);
    border-bottom: 1px solid rgba(255,255,255,0.06);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 24px;
    z-index: 50;
    backdrop-filter: blur(12px);
  }
  #header h1 {
    font-size: 1rem;
    font-weight: 600;
    letter-spacing: 0.03em;
  }
  #header .subtitle {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem;
    color: #64748b;
  }
  .legend {
    display: flex;
    gap: 16px;
    align-items: center;
    flex-wrap: wrap;
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.7rem;
    color: #94a3b8;
    font-family: 'JetBrains Mono', monospace;
  }
  .legend-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
  }
  .legend-rect {
    width: 14px; height: 10px;
    border-radius: 3px;
  }

  /* Zoom controls */
  #zoom-controls {
    position: fixed;
    bottom: 24px;
    right: 24px;
    display: flex;
    gap: 8px;
    z-index: 50;
  }
  .zoom-btn {
    width: 40px; height: 40px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.1);
    background: rgba(15,23,42,0.9);
    color: #94a3b8;
    font-size: 1.2rem;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
    backdrop-filter: blur(8px);
  }
  .zoom-btn:hover { background: rgba(99,102,241,0.2); color: #e2e8f0; border-color: rgba(99,102,241,0.4); }

  /* Animated grid background */
  #bg-grid {
    position: fixed;
    top: 56px; left: 0;
    width: 100%; height: calc(100% - 56px);
    background-image:
      radial-gradient(circle at 25% 35%, rgba(99,102,241,0.04) 0%, transparent 50%),
      radial-gradient(circle at 75% 65%, rgba(16,185,129,0.03) 0%, transparent 50%),
      linear-gradient(rgba(255,255,255,0.015) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255,255,255,0.015) 1px, transparent 1px);
    background-size: 100% 100%, 100% 100%, 40px 40px, 40px 40px;
    z-index: 0;
    pointer-events: none;
  }

  /* Connection labels */
  .conn-label {
    position: absolute;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.55rem;
    color: rgba(148,163,184,0.6);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    pointer-events: none;
    z-index: 5;
    background: rgba(10,14,26,0.8);
    padding: 2px 6px;
    border-radius: 4px;
  }
</style>
</head>
<body>

<nav class="main-nav">
    <a href="/" class="logo">Homebase</a>
    <div class="nav-links">
        <a href="/">Dashboard</a>
        <a href="/fleet">Fleet</a>
        <a href="/agents">Agents</a>
        <a href="/sentinel">Sentinel</a>
        <a href="/research">Research</a>
        <a href="/infra">Infra Sheet</a>
        <a href="/settings">Settings</a>
        <a href="/backups">Backups</a>
    </div>
</nav>

<div id="bg-grid"></div>

<div id="header">
  <div>
    <h1>ðŸ§  Rize Agent Mind Map</h1>
    <span class="subtitle">Fleet Architecture â€” Servers, Agents & Services</span>
  </div>
  <div class="legend">
    <div class="legend-item"><div class="legend-rect" style="background:#a78bfa;"></div>Server</div>
    <div class="legend-item"><div class="legend-dot" style="background:#6366f1;"></div>C2</div>
    <div class="legend-item"><div class="legend-dot" style="background:#10b981;"></div>Agent</div>
    <div class="legend-item"><div class="legend-dot" style="background:#f59e0b;"></div>Oversight</div>
    <div class="legend-item"><div class="legend-dot" style="background:#a855f7;"></div>Platform</div>
    <div class="legend-item"><div class="legend-dot" style="background:#ec4899;"></div>Demo</div>
    <div class="legend-item"><div class="legend-dot" style="background:#22d3ee;border:1px dashed rgba(34,211,238,0.5);"></div>Script</div>
  </div>
</div>

<div id="canvas-container">
  <div id="canvas">
    <svg id="connections"></svg>
  </div>
</div>

<div id="detail-panel">
  <button id="close-panel" onclick="closePanel()">âœ•</button>
  <div id="panel-content"></div>
</div>

<div id="zoom-controls">
  <button class="zoom-btn" onclick="zoomIn()">+</button>
  <button class="zoom-btn" onclick="zoomOut()">âˆ’</button>
  <button class="zoom-btn" onclick="resetView()" title="Reset view">âŸ²</button>
  <button class="zoom-btn" onclick="resetLayout()" title="Reset node positions" style="font-size:0.7rem;">Reset Layout</button>
</div>

<script>
// === SERVER NODES (new) ===
const SERVERS = {
  'server-talos': {
    id: 'server-talos', name: 'Talos', icon: 'ðŸ–¥ï¸', type: 'server', serverType: 'talos',
    role: 'C2 Command Hub',
    x: 200, y: 100,
    ip: '192.168.65.237', user: 'talosadmin',
    status: 'active',
    detail: 'Central command and control server. SSH gateway to all fleet servers, Claude Code execution via tmux, Cloudflare tunnel for external access.',
    services: ['Claude Code', 'Cortex', 'Architect', 'Inquisitor', 'ttyd', 'Talos Drop'],
    ports: [':7681 ttyd', ':8080 Dashboard', ':8888 Drop', ':9100 Cortex']
  },
  'server-agents': {
    id: 'server-agents', name: 'Agents', icon: 'ðŸ¤–', type: 'server', serverType: 'agents',
    role: 'AI Agent Host',
    x: 200, y: 500,
    ip: '192.168.65.241', user: 'agents',
    status: 'active',
    detail: 'Hosts all AI agents: David Bishop, Apex, and Aegis. Each agent runs as a systemd service.',
    services: ['David Bishop', 'Apex', 'Aegis'],
    ports: [':9001 David', ':9002 Apex', ':9003 Aegis', ':3978 Bot Framework']
  },
  'server-rizeapps': {
    id: 'server-rizeapps', name: 'Rize-Apps', icon: 'ðŸ ', type: 'server', serverType: 'rizeapps',
    role: 'Production Apps',
    x: 200, y: 900,
    ip: '192.168.65.245', user: 'rizeadmin',
    status: 'active',
    detail: 'Production application server. Hosts Homebase, Sentinel, Property Rize, Nexus, Dockyard, Relay, and OpenHands.',
    services: ['Homebase', 'Sentinel', 'Property Rize', 'Nexus', 'Dockyard', 'Relay', 'OpenHands'],
    ports: [':8000 Homebase', ':8501 Property Rize', ':3002 Nexus', ':8080 Dockyard', ':8888 Relay', ':3000 OpenHands']
  },
  'server-demos': {
    id: 'server-demos', name: 'Demos', icon: 'ðŸŽ­', type: 'server', serverType: 'demos',
    role: 'Demo Showcase',
    x: 200, y: 1300,
    ip: '192.168.65.246', user: 'demos',
    status: 'active',
    detail: 'Demo server for client presentations. Hosts BEST Shipping, BPS AI, Premier EMR, and Helios demos.',
    services: ['BEST Shipping', 'BPS AI', 'Premier EMR', 'Helios'],
    ports: [':3000 BPS-AI', ':3001 BEST FE', ':8001 BEST API', ':3004 Premier EMR', ':3005 Helios']
  },
  'server-vector': {
    id: 'server-vector', name: 'Vector', icon: 'ðŸš', type: 'server', serverType: 'vector',
    role: 'Air Ambulance â€” CRITICAL',
    x: 200, y: 1700,
    ip: '192.168.65.249', user: 'betadmin',
    status: 'critical',
    detail: 'LIFE-CRITICAL air ambulance operations. BET Air Ambulance dispatch, flight tracking, patient records. Highest priority server.',
    services: ['Vector EMR', 'Dispatch System', 'Flight Tracking'],
    ports: ['Various']
  }
};

const AGENTS = {
  talos: {
    id: 'talos', name: 'Talos C2', icon: 'ðŸŽ¯', type: 'c2',
    role: 'C2 Dashboard',
    x: 500, y: 100,
    status: 'active', server: 'server-talos',
    detail: 'Central C2 dashboard and orchestrator. SSH gateway, Claude Code execution, fleet-wide script deployment.',
    capabilities: ['SSH C2 to all servers', 'Claude Code execution', 'Ollama AI models (DeepSeek/Qwen)', 'Fleet-wide script deployment', 'tmux parallel sessions'],
    ports: ['Dashboard :8080', 'Drop :8888', 'ttyd :7681'],
    comms: ['SSH to .241, .245, .246, .249', 'Cloudflare tunnel: talos-ssh.rize.bm']
  },
  cortex: {
    id: 'cortex', name: 'Cortex', icon: 'ðŸ§ ', type: 'c2',
    role: 'Intelligence Engine',
    x: 700, y: 200,
    status: 'active', server: 'server-talos',
    detail: 'Fleet scanning, drift detection, baseline tracking, context API. Coordinates Architect and Inquisitor jobs.',
    capabilities: ['Fleet health scanning', 'Service drift detection', 'Baseline state tracking', 'Agent status aggregation', 'Tunnel monitoring', 'Daily briefing generation'],
    ports: [':9100'],
    comms: ['Reads infrastructure.json', 'SSHes to fleet for metrics', 'Reports to Homebase']
  },
  architect: {
    id: 'architect', name: 'The Architect', icon: 'ðŸ—ï¸', type: 'script',
    role: 'Builder Script â€” C2',
    x: 600, y: 340,
    status: 'active', server: 'server-talos',
    detail: 'Claude Code builder personality. Reads fleet manifest, builds systems, creates documentation.',
    capabilities: ['Full fleet build & deploy', '9-doc standard per agent', 'py_compile verification', 'Backup-before-edit protocol'],
    ports: ['N/A â€” CLI persona'],
    comms: ['SSH to all servers via Talos', 'Produces ARCHITECT-VERIFICATION-REPORT.md']
  },
  inquisitor: {
    id: 'inquisitor', name: 'The Inquisitor', icon: 'ðŸ”', type: 'script',
    role: 'Auditor Script â€” C2',
    x: 850, y: 340,
    status: 'active', server: 'server-talos',
    detail: 'Zero-trust adversarial QA persona. Red-teams every endpoint, tests PII filters, grades Architect\'s work.',
    capabilities: ['Static analysis', 'Endpoint torture testing', 'Cross-reference validation', 'Security deep dive'],
    ports: ['N/A â€” CLI persona'],
    comms: ['SSH to all servers via Talos', 'Reads ARCHITECT-VERIFICATION-REPORT.md']
  },
  david: {
    id: 'david', name: 'David Bishop', icon: 'ðŸ•´ï¸', type: 'agent',
    role: 'Security / Email / Teams Agent',
    x: 500, y: 500,
    status: 'live', server: 'server-agents',
    detail: 'LIVE production agent. Email triage, Teams messaging, Telegram bot, security alerts. Strict guardrails.',
    capabilities: ['Email triage & response', 'Teams messaging', 'Telegram bot (@Morpheus_99_bot)', 'Security alert processing', 'Daily status reports'],
    ports: [':3978 (Bot Framework)', ':9001 (API)'],
    comms: ['Email: dbishop@rize.bm', 'Teams: Bot Framework', 'Telegram: @Morpheus_99_bot']
  },
  apex: {
    id: 'apex', name: 'Apex', icon: 'ðŸ’°', type: 'agent',
    role: 'Finance Agent',
    x: 700, y: 600,
    status: 'readonly', server: 'server-agents',
    detail: 'Phase 1 read-only finance agent. Xero + Halo PSA integration. Revenue leakage detection.',
    capabilities: ['Xero P&L sync', 'Halo timesheet analysis', 'Revenue leakage detection', 'Unbilled hours alerts'],
    ports: [':9002'],
    comms: ['Email: apex@rize.bm', 'MOCK_MODE=true']
  },
  aegis: {
    id: 'aegis', name: 'Aegis', icon: 'ðŸ›¡ï¸', type: 'agent',
    role: 'Infrastructure Agent',
    x: 900, y: 500,
    status: 'readonly', server: 'server-agents',
    detail: 'Phase 1 read-only infrastructure monitoring. PRTG + Action1 + Halo PSA correlation.',
    capabilities: ['PRTG sensor/alert sync', 'Action1 patch compliance', 'Halo ticket correlation', 'SSL expiration tracking'],
    ports: [':9003'],
    comms: ['Email: aegis@rize.bm', 'MOCK_MODE=true']
  },
  sentinel: {
    id: 'sentinel', name: 'Sentinel', icon: 'ðŸ‘ï¸', type: 'oversight',
    role: 'Oversight Agent',
    x: 700, y: 780,
    status: 'active', server: 'server-rizeapps',
    detail: 'Agent oversight with kill switch, auto-restart, PII gateway. Monitors all agents. Cannot modify guardrails.',
    capabilities: ['Agent kill switch', 'Auto-restart crashed agents', 'PII gateway filtering', 'Compliance tracking', 'Audit logging'],
    ports: ['Integrated into Homebase'],
    comms: ['Security alerts â†’ aidev@rize.bm', 'CEO alerts â†’ artiedarrell@gmail.com']
  },
  homebase: {
    id: 'homebase', name: 'Homebase', icon: 'ðŸ ', type: 'platform',
    role: 'Dashboard & Platform',
    x: 500, y: 900,
    status: 'active', server: 'server-rizeapps',
    detail: 'Central dashboard for entire fleet. Servers, projects, agents, metrics, security, research.',
    capabilities: ['Fleet server monitoring', 'Project tracking', 'Agent registration & heartbeats', 'Sentinel dashboard', 'Research Scout'],
    ports: [':8000'],
    comms: ['homebase.rize.bm', 'Receives heartbeats from all agents']
  },
  propertyrize: {
    id: 'propertyrize', name: 'Property Rize', icon: 'ðŸ¢', type: 'platform',
    role: 'Real Estate Platform',
    x: 900, y: 900,
    status: 'active', server: 'server-rizeapps',
    detail: 'Real estate management platform. Listings, tenant management, analytics.',
    capabilities: ['Property listings', 'Tenant management', 'Analytics dashboard'],
    ports: [':8501'],
    comms: ['propertyrize.rize.bm']
  },
  best: {
    id: 'best', name: 'BEST Shipping', icon: 'ðŸš¢', type: 'demo',
    role: 'Freight Dashboard',
    x: 500, y: 1300,
    status: 'active', server: 'server-demos',
    detail: 'Freight management dashboard for Best Shipping. Replaces CargoWise eHub.',
    capabilities: ['Shipment tracking', 'Financial overview', 'Document center', 'Customer portal'],
    ports: [':8001 API', ':3001 Frontend'],
    comms: ['bestshipping.rize.bm']
  },
  bpsai: {
    id: 'bpsai', name: 'BPS AI', icon: 'âš–ï¸', type: 'demo',
    role: 'Legal AI',
    x: 700, y: 1400,
    status: 'active', server: 'server-demos',
    detail: 'AI-powered case management for BPS law firm. Document analysis, case timeline.',
    capabilities: ['AI case analysis', 'Document processing', 'Legal research assistant'],
    ports: [':3000'],
    comms: ['bpsai.rize.bm']
  },
  premieremr: {
    id: 'premieremr', name: 'Premier EMR', icon: 'ðŸ¥', type: 'demo',
    role: 'Medical Records Demo',
    x: 500, y: 1500,
    status: 'active', server: 'server-demos',
    detail: 'Electronic medical records demo for Premier Healthcare.',
    capabilities: ['Patient records', 'Appointment scheduling', 'Medical history'],
    ports: [':3004'],
    comms: ['premieremr.rize.bm']
  },
  helios: {
    id: 'helios', name: 'Helios', icon: 'â˜€ï¸', type: 'demo',
    role: 'Solar Analytics',
    x: 900, y: 1300,
    status: 'active', server: 'server-demos',
    detail: 'Solar energy analytics and monitoring platform demo.',
    capabilities: ['Solar panel monitoring', 'Energy analytics', 'Performance tracking'],
    ports: [':3005'],
    comms: ['helios.rize.bm']
  },
  vector: {
    id: 'vector', name: 'Vector EMR', icon: 'ðŸš', type: 'demo',
    role: 'Air Ambulance â€” PRIORITY',
    x: 500, y: 1700,
    status: 'live', server: 'server-vector',
    detail: 'LIFE-CRITICAL air ambulance operations. Flight tracking, patient records, dispatch.',
    capabilities: ['Air ambulance dispatch', 'Flight tracking', 'Patient records', 'Operational dashboards'],
    ports: ['Various on .249'],
    comms: ['vector.rize.bm', 'PRIORITY: Life-critical']
  }
};

const CONNECTIONS = [
  // Server to server (SSH C2)
  { from: 'server-talos', to: 'server-agents', label: 'SSH C2', style: 'solid', color: 'purple' },
  { from: 'server-talos', to: 'server-rizeapps', label: 'SSH C2', style: 'solid', color: 'purple' },
  { from: 'server-talos', to: 'server-demos', label: 'SSH C2', style: 'solid', color: 'purple' },
  { from: 'server-talos', to: 'server-vector', label: 'SSH C2', style: 'solid', color: 'purple' },

  // Server to their services
  { from: 'server-talos', to: 'talos', label: 'hosts', style: 'solid' },
  { from: 'server-talos', to: 'cortex', label: 'hosts', style: 'solid' },
  { from: 'server-talos', to: 'architect', label: 'runs', style: 'dashed' },
  { from: 'server-talos', to: 'inquisitor', label: 'runs', style: 'dashed' },
  { from: 'server-agents', to: 'david', label: 'hosts', style: 'solid' },
  { from: 'server-agents', to: 'apex', label: 'hosts', style: 'solid' },
  { from: 'server-agents', to: 'aegis', label: 'hosts', style: 'solid' },
  { from: 'server-rizeapps', to: 'homebase', label: 'hosts', style: 'solid' },
  { from: 'server-rizeapps', to: 'sentinel', label: 'hosts', style: 'solid' },
  { from: 'server-rizeapps', to: 'propertyrize', label: 'hosts', style: 'solid' },
  { from: 'server-demos', to: 'best', label: 'hosts', style: 'solid' },
  { from: 'server-demos', to: 'bpsai', label: 'hosts', style: 'solid' },
  { from: 'server-demos', to: 'premieremr', label: 'hosts', style: 'solid' },
  { from: 'server-demos', to: 'helios', label: 'hosts', style: 'solid' },
  { from: 'server-vector', to: 'vector', label: 'hosts', style: 'solid' },

  // Agent heartbeats
  { from: 'david', to: 'homebase', label: 'heartbeat', style: 'dotted' },
  { from: 'apex', to: 'homebase', label: 'heartbeat', style: 'dotted' },
  { from: 'aegis', to: 'homebase', label: 'heartbeat', style: 'dotted' },

  // Sentinel oversight (dotted)
  { from: 'sentinel', to: 'david', label: 'monitors', style: 'dotted', color: 'orange' },
  { from: 'sentinel', to: 'apex', label: 'monitors', style: 'dotted', color: 'orange' },
  { from: 'sentinel', to: 'aegis', label: 'monitors', style: 'dotted', color: 'orange' },
  { from: 'sentinel', to: 'cortex', label: 'monitors', style: 'dotted', color: 'orange' },

  // Cortex orchestration (dashed)
  { from: 'cortex', to: 'architect', label: 'orchestrates', style: 'dashed', color: 'cyan' },
  { from: 'cortex', to: 'inquisitor', label: 'orchestrates', style: 'dashed', color: 'cyan' },
  { from: 'cortex', to: 'homebase', label: 'feeds data', style: 'dotted' },

  // Architect â†’ Inquisitor verification
  { from: 'architect', to: 'inquisitor', label: 'verified by', style: 'dashed' }
];

// Merge all nodes
const ALL_NODES = { ...SERVERS, ...AGENTS };

// State
let scale = 0.65;
let panX = 50;
let panY = -50;
let isDragging = false;
let lastMouseX, lastMouseY;

// === NODE DRAGGING ===
let nodeDragging = null;
let nodeStartX = 0, nodeStartY = 0;
let nodeOffsetX = 0, nodeOffsetY = 0;
let hasMoved = false;

function getSavedPositions() {
  try {
    const saved = sessionStorage.getItem('mindmap_node_positions_v2');
    return saved ? JSON.parse(saved) : {};
  } catch { return {}; }
}

function savePositions() {
  const positions = {};
  Object.values(ALL_NODES).forEach(a => {
    const node = document.getElementById('node-' + a.id);
    if (node) {
      positions[a.id] = { x: parseInt(node.style.left), y: parseInt(node.style.top) };
    }
  });
  sessionStorage.setItem('mindmap_node_positions_v2', JSON.stringify(positions));
}

function resetLayout() {
  if (!confirm('Reset all nodes to default positions?')) return;
  sessionStorage.removeItem('mindmap_node_positions_v2');
  Object.values(ALL_NODES).forEach(a => {
    const node = document.getElementById('node-' + a.id);
    if (node) {
      node.style.left = a.x + 'px';
      node.style.top = a.y + 'px';
    }
  });
  drawConnections();
}

function init() {
  const canvas = document.getElementById('canvas');

  // Create nodes for both servers and agents
  Object.values(ALL_NODES).forEach(item => {
    const node = document.createElement('div');
    const isServer = item.type === 'server';

    if (isServer) {
      node.className = `node node-server node-server-${item.serverType}`;
    } else {
      node.className = `node node-${item.type}`;
    }
    node.id = `node-${item.id}`;
    node.style.left = item.x + 'px';
    node.style.top = item.y + 'px';

    const statusClass = item.status === 'live' ? 'status-live' :
                        item.status === 'readonly' ? 'status-readonly' :
                        item.status === 'planned' ? 'status-planned' :
                        item.status === 'critical' ? 'status-critical' : 'status-active';

    if (isServer) {
      node.innerHTML = `
        <div class="node-header">
          <span class="node-icon">${item.icon}</span>
          <span class="node-name">${item.name}</span>
          <span class="node-ip">${item.ip}</span>
        </div>
        <div class="node-role">${item.role}</div>
        <div class="node-detail">${item.detail.substring(0, 100)}${item.detail.length > 100 ? 'â€¦' : ''}</div>
        <div class="node-server-info">${item.user}@${item.ip}</div>
      `;
    } else {
      node.innerHTML = `
        <div class="node-header">
          <span class="node-icon">${item.icon}</span>
          <span class="node-name">${item.name}</span>
          <span class="node-status ${statusClass}">${item.status}</span>
        </div>
        <div class="node-role">${item.role}</div>
        <div class="node-detail">${item.detail.substring(0, 80)}${item.detail.length > 80 ? 'â€¦' : ''}</div>
        <div class="node-server-info">${SERVERS[item.server] ? SERVERS[item.server].ip : item.server}</div>
      `;
    }

    // Node mousedown for dragging
    node.addEventListener('mousedown', (e) => {
      if (e.button !== 0) return;
      e.stopPropagation();
      nodeDragging = node;
      hasMoved = false;
      nodeStartX = parseInt(node.style.left);
      nodeStartY = parseInt(node.style.top);
      nodeOffsetX = e.clientX / scale - nodeStartX - panX;
      nodeOffsetY = e.clientY / scale - nodeStartY - panY;
      node.classList.add('dragging');
    });

    // Click only fires if no drag occurred
    node.addEventListener('click', (e) => {
      e.stopPropagation();
      if (!hasMoved) showDetail(item);
    });

    canvas.appendChild(node);
  });

  // Document-level handlers for node dragging
  document.addEventListener('mousemove', (e) => {
    if (!nodeDragging) return;
    hasMoved = true;
    const newX = e.clientX / scale - nodeOffsetX - panX;
    const newY = e.clientY / scale - nodeOffsetY - panY;
    nodeDragging.style.left = newX + 'px';
    nodeDragging.style.top = newY + 'px';
    drawConnections();
  });

  document.addEventListener('mouseup', () => {
    if (nodeDragging) {
      nodeDragging.classList.remove('dragging');
      if (hasMoved) savePositions();
      nodeDragging = null;
    }
  });

  drawConnections();
  updateTransform();

  // Pan handlers
  const container = document.getElementById('canvas-container');
  container.addEventListener('mousedown', (e) => {
    if (e.target.closest('.node')) return;
    if (nodeDragging) return;
    isDragging = true;
    lastMouseX = e.clientX;
    lastMouseY = e.clientY;
  });
  document.addEventListener('mousemove', (e) => {
    if (nodeDragging) return;
    if (!isDragging) return;
    panX += (e.clientX - lastMouseX);
    panY += (e.clientY - lastMouseY);
    lastMouseX = e.clientX;
    lastMouseY = e.clientY;
    updateTransform();
  });
  document.addEventListener('mouseup', () => isDragging = false);

  // Zoom with scroll
  container.addEventListener('wheel', (e) => {
    e.preventDefault();
    const delta = e.deltaY > 0 ? -0.05 : 0.05;
    scale = Math.max(0.3, Math.min(2, scale + delta));
    updateTransform();
  });

  // Click outside to close panel
  container.addEventListener('click', (e) => {
    if (!e.target.closest('.node') && !e.target.closest('#detail-panel')) {
      closePanel();
    }
  });
}

function updateTransform() {
  const canvas = document.getElementById('canvas');
  canvas.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
}

function drawConnections() {
  const svg = document.getElementById('connections');
  svg.innerHTML = '';

  const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');

  // Regular arrowhead
  const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
  marker.setAttribute('id', 'arrowhead');
  marker.setAttribute('markerWidth', '8');
  marker.setAttribute('markerHeight', '6');
  marker.setAttribute('refX', '8');
  marker.setAttribute('refY', '3');
  marker.setAttribute('orient', 'auto');
  const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
  polygon.setAttribute('points', '0 0, 8 3, 0 6');
  polygon.setAttribute('fill', 'rgba(100,116,139,0.4)');
  marker.appendChild(polygon);
  defs.appendChild(marker);

  // Purple arrowhead for SSH
  const markerPurple = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
  markerPurple.setAttribute('id', 'arrowhead-purple');
  markerPurple.setAttribute('markerWidth', '8');
  markerPurple.setAttribute('markerHeight', '6');
  markerPurple.setAttribute('refX', '8');
  markerPurple.setAttribute('refY', '3');
  markerPurple.setAttribute('orient', 'auto');
  const polygonPurple = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
  polygonPurple.setAttribute('points', '0 0, 8 3, 0 6');
  polygonPurple.setAttribute('fill', 'rgba(167,139,250,0.6)');
  markerPurple.appendChild(polygonPurple);
  defs.appendChild(markerPurple);

  // Orange arrowhead for oversight
  const markerOrange = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
  markerOrange.setAttribute('id', 'arrowhead-orange');
  markerOrange.setAttribute('markerWidth', '8');
  markerOrange.setAttribute('markerHeight', '6');
  markerOrange.setAttribute('refX', '8');
  markerOrange.setAttribute('refY', '3');
  markerOrange.setAttribute('orient', 'auto');
  const polygonOrange = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
  polygonOrange.setAttribute('points', '0 0, 8 3, 0 6');
  polygonOrange.setAttribute('fill', 'rgba(245,158,11,0.6)');
  markerOrange.appendChild(polygonOrange);
  defs.appendChild(markerOrange);

  // Cyan arrowhead for orchestration
  const markerCyan = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
  markerCyan.setAttribute('id', 'arrowhead-cyan');
  markerCyan.setAttribute('markerWidth', '8');
  markerCyan.setAttribute('markerHeight', '6');
  markerCyan.setAttribute('refX', '8');
  markerCyan.setAttribute('refY', '3');
  markerCyan.setAttribute('orient', 'auto');
  const polygonCyan = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
  polygonCyan.setAttribute('points', '0 0, 8 3, 0 6');
  polygonCyan.setAttribute('fill', 'rgba(34,211,238,0.6)');
  markerCyan.appendChild(polygonCyan);
  defs.appendChild(markerCyan);

  svg.appendChild(defs);

  CONNECTIONS.forEach(conn => {
    const fromNode = document.getElementById(`node-${conn.from}`);
    const toNode = document.getElementById(`node-${conn.to}`);
    if (!fromNode || !toNode) return;

    const fx = parseInt(fromNode.style.left) + fromNode.offsetWidth / 2;
    const fy = parseInt(fromNode.style.top) + fromNode.offsetHeight / 2;
    const tx = parseInt(toNode.style.left) + toNode.offsetWidth / 2;
    const ty = parseInt(toNode.style.top) + toNode.offsetHeight / 2;

    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    line.setAttribute('x1', fx);
    line.setAttribute('y1', fy);
    line.setAttribute('x2', tx);
    line.setAttribute('y2', ty);

    let color, markerEnd;
    if (conn.color === 'purple') {
      color = 'rgba(167,139,250,0.35)';
      markerEnd = 'url(#arrowhead-purple)';
    } else if (conn.color === 'orange') {
      color = 'rgba(245,158,11,0.3)';
      markerEnd = 'url(#arrowhead-orange)';
    } else if (conn.color === 'cyan') {
      color = 'rgba(34,211,238,0.3)';
      markerEnd = 'url(#arrowhead-cyan)';
    } else if (conn.style === 'dashed') {
      color = 'rgba(34,211,238,0.2)';
      markerEnd = 'url(#arrowhead)';
    } else if (conn.style === 'dotted') {
      color = 'rgba(16,185,129,0.2)';
      markerEnd = 'url(#arrowhead)';
    } else {
      color = 'rgba(100,116,139,0.2)';
      markerEnd = 'url(#arrowhead)';
    }

    line.setAttribute('stroke', color);
    line.setAttribute('stroke-width', conn.color === 'purple' ? '2' : '1.5');
    line.setAttribute('marker-end', markerEnd);

    if (conn.style === 'dashed') line.setAttribute('stroke-dasharray', '8,4');
    if (conn.style === 'dotted') line.setAttribute('stroke-dasharray', '3,3');

    svg.appendChild(line);
  });
}

function showDetail(item) {
  const panel = document.getElementById('detail-panel');
  const content = document.getElementById('panel-content');
  const isServer = item.type === 'server';

  const statusClass = item.status === 'live' ? 'status-live' :
                      item.status === 'readonly' ? 'status-readonly' :
                      item.status === 'planned' ? 'status-planned' :
                      item.status === 'critical' ? 'status-critical' : 'status-active';

  if (isServer) {
    content.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:4px;">
        <span style="font-size:2rem;">${item.icon}</span>
        <h2>${item.name}</h2>
        <span class="node-status ${statusClass}" style="margin-left:auto;">${item.status}</span>
      </div>
      <div class="detail-role">${item.role}</div>

      <div class="detail-section">
        <h3>Overview</h3>
        <p>${item.detail}</p>
      </div>

      <div class="detail-section">
        <h3>Connection</h3>
        <p style="font-family:'JetBrains Mono',monospace;font-size:0.9rem;">${item.user}@${item.ip}</p>
      </div>

      <div class="detail-section">
        <h3>Services</h3>
        <ul>${item.services.map(s => `<li>${s}</li>`).join('')}</ul>
      </div>

      <div class="detail-section">
        <h3>Ports</h3>
        <ul>${item.ports.map(p => `<li style="font-family:'JetBrains Mono',monospace;font-size:0.8rem;">${p}</li>`).join('')}</ul>
      </div>
    `;
  } else {
    content.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:4px;">
        <span style="font-size:2rem;">${item.icon}</span>
        <h2>${item.name}</h2>
        <span class="node-status ${statusClass}" style="margin-left:auto;">${item.status}</span>
      </div>
      <div class="detail-role">${item.role}</div>

      <div class="detail-section">
        <h3>Overview</h3>
        <p>${item.detail}</p>
      </div>

      <div class="detail-section">
        <h3>Capabilities</h3>
        <ul>${item.capabilities.map(c => `<li>${c}</li>`).join('')}</ul>
      </div>

      <div class="detail-section">
        <h3>Ports</h3>
        <ul>${item.ports.map(p => `<li style="font-family:'JetBrains Mono',monospace;font-size:0.8rem;">${p}</li>`).join('')}</ul>
      </div>

      <div class="detail-section">
        <h3>Communication</h3>
        <ul>${item.comms.map(c => `<li>${c}</li>`).join('')}</ul>
      </div>

      <div class="detail-section">
        <h3>Host</h3>
        <p style="font-family:'JetBrains Mono',monospace;font-size:0.8rem;">${SERVERS[item.server] ? SERVERS[item.server].ip : item.server}</p>
      </div>
    `;
  }

  panel.classList.add('open');

  // Highlight connections
  document.querySelectorAll('.node').forEach(n => n.style.opacity = '0.3');
  document.getElementById(`node-${item.id}`).style.opacity = '1';
  CONNECTIONS.forEach(c => {
    if (c.from === item.id) {
      const el = document.getElementById(`node-${c.to}`);
      if (el) el.style.opacity = '1';
    }
    if (c.to === item.id) {
      const el = document.getElementById(`node-${c.from}`);
      if (el) el.style.opacity = '1';
    }
  });
}

function closePanel() {
  document.getElementById('detail-panel').classList.remove('open');
  document.querySelectorAll('.node').forEach(n => n.style.opacity = '1');
}

function zoomIn() { scale = Math.min(2, scale + 0.1); updateTransform(); }
function zoomOut() { scale = Math.max(0.3, scale - 0.1); updateTransform(); }
function resetView() { scale = 0.65; panX = 50; panY = -50; updateTransform(); }

window.addEventListener('DOMContentLoaded', init);
window.addEventListener('load', () => setTimeout(drawConnections, 100));
</script>
</body>
</html>
