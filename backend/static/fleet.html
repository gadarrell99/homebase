<!DOCTYPE html>
<html lang="en">
<head>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè†</text></svg>">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleet | Homebase</title>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #e2e8f0; min-height: 100vh; }
.main-nav { display: flex; align-items: center; padding: 0.75rem 1.5rem; background: #1e293b; border-bottom: 1px solid #334155; position: sticky; top: 0; z-index: 100; }
.main-nav .logo { font-size: 1.1rem; font-weight: 600; color: #e2e8f0; margin-right: 2rem; text-decoration: none; }
.main-nav .nav-links { display: flex; gap: 0.25rem; flex: 1; flex-wrap: wrap; align-items: center; }
.main-nav .nav-links a { color: #94a3b8; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-size: 0.875rem; text-decoration: none; transition: all 0.15s; }
.main-nav .nav-links a:hover, .main-nav .nav-links a.active { color: #e2e8f0; background: #334155; }

a { color: #60a5fa; text-decoration: none; }
a:hover { color: #93c5fd; }

.main-nav .nav-links > a { color: #94a3b8; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-size: 0.875rem; text-decoration: none; transition: all 0.15s; }
.main-nav .nav-links > a:hover, .main-nav .nav-links > a.active { color: #e2e8f0; background: #334155; }

.page-container { padding: 1.5rem; max-width: 1400px; margin: 0 auto; }
.page-header { margin-bottom: 1.5rem; }
.page-header h1 { font-size: 1.75rem; font-weight: 600; margin-bottom: 0.25rem; }
.page-header p { color: #64748b; font-size: 0.875rem; }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
.stat-card { background: #1e293b; border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem; text-align: center; }
.stat-value { font-size: 2rem; font-weight: 700; color: #e2e8f0; }
.stat-value.green { color: #4ade80; }
.stat-value.yellow { color: #fbbf24; }
.stat-value.red { color: #f87171; }
.stat-label { color: #94a3b8; font-size: 0.75rem; margin-top: 0.25rem; }
.server-card { background: #1e293b; border: 1px solid #334155; border-radius: 0.5rem; margin-bottom: 1rem; overflow: hidden; }
.server-header { display: flex; align-items: center; padding: 1rem; background: #0f172a; cursor: pointer; }
.server-header:hover { background: #1a1a2e; }
.server-icon { font-size: 1.5rem; margin-right: 1rem; }
.server-info { flex: 1; }
.server-name { font-weight: 600; font-size: 1rem; margin-bottom: 0.25rem; }
.server-meta { font-size: 0.75rem; color: #64748b; font-family: monospace; }
.server-status { padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.7rem; font-weight: 600; }
.status-online { background: #166534; color: #86efac; }
.status-decom { background: #374151; color: #9ca3af; }
.server-body { padding: 1rem; }
.projects-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 0.75rem; }
.project-card { background: #0f172a; border: 1px solid #334155; border-radius: 0.375rem; padding: 0.75rem; transition: all 0.15s; }
.project-card:hover { border-color: #60a5fa; transform: translateY(-1px); }
.project-name { font-weight: 500; font-size: 0.875rem; margin-bottom: 0.25rem; }
.project-port { font-size: 0.7rem; color: #64748b; font-family: monospace; }
.project-status { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 0.5rem; }
.project-status.running { background: #4ade80; }
.project-status.stopped { background: #f87171; }
.project-status.unknown { background: #fbbf24; }
.project-status.mock { background: #a855f7; }
.project-card.agent-item { border-color: #6366f1; }
.project-card.agent-item:hover { border-color: #818cf8; }
.collapse-section { margin-top: 1.5rem; }
.collapse-header { display: flex; align-items: center; padding: 0.75rem 1rem; background: #1e293b; border: 1px solid #334155; border-radius: 0.375rem; cursor: pointer; color: #64748b; font-size: 0.875rem; }
.collapse-header:hover { color: #e2e8f0; }
.collapse-header .arrow { margin-right: 0.5rem; transition: transform 0.2s; }
.collapse-header.open .arrow { transform: rotate(90deg); }
.collapse-body { display: none; padding: 1rem 0; }
.collapse-body.open { display: block; }
.decom-card { opacity: 0.5; }
.updated { font-size: 0.7rem; color: #475569; text-align: right; margin-top: 1rem; }
@media (max-width: 768px) { .page-container { padding: 1rem; } .stats-grid { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>
    <nav class="main-nav">
    <a href="/" class="logo">Homebase</a>
    <div class="nav-links">
        <a href="/">Dashboard</a>
        <a href="/fleet" class="active">Fleet</a>
        <a href="/agents">Agents</a>
        <a href="/sentinel">Sentinel</a>
        <a href="/research">Research</a>
        <a href="/infra">Infra Sheet</a>
        <a href="/settings">Settings</a>
        <a href="/backups">Backups</a>
        <a href="/requirements">Requirements</a>
        <a href="https://gitea.rize.bm" target="_blank">Gitea</a>
    </div>
</nav>

    <div class="page-container">
        <div class="page-header">
            <h1>Fleet Overview</h1>
            <p>Servers and projects across the Rize infrastructure</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value green" id="active-servers">-</div>
                <div class="stat-label">Active Servers</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-projects">-</div>
                <div class="stat-label">Projects</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-agents">-</div>
                <div class="stat-label">AI Agents</div>
            </div>
            <div class="stat-card">
                <div class="stat-value yellow" id="decom-servers">-</div>
                <div class="stat-label">Decommissioned</div>
            </div>
        </div>

        <div id="servers-container"></div>

        <div class="collapse-section">
            <div class="collapse-header" id="decom-header">
                <span class="arrow">‚ñ∏</span>
                <span>Decommissioned Servers (<span id="decom-count">0</span>)</span>
            </div>
            <div class="collapse-body" id="decom-body"></div>
        </div>

        <div class="updated" id="last-updated"></div>
    </div>

    <script src="/static/cache-helper.js"></script>
<script>
    async function loadFleet() {
        try {
            const res = await fetch('/api/fleet');
            const data = await res.json();
            
            // Stats
            document.getElementById('active-servers').textContent = data.summary.active_servers;
            document.getElementById('total-projects').textContent = data.summary.total_projects;
            document.getElementById('total-agents').textContent = data.summary.total_agents;
            document.getElementById('decom-servers').textContent = data.summary.decommissioned_servers;
            document.getElementById('decom-count').textContent = data.summary.decommissioned_servers;
            
            // Active servers
            const serversHtml = data.servers.map(server => {
                const projects = data.projects.filter(p => p.server === server.id && !p.hidden);
                // FIX 1: Also include agents that live on this server
                const serverAgents = (data.agents || []).filter(a => a.server === server.id && a.type === 'agent');
                const agentCards = serverAgents.map(a => ({
                    id: a.id,
                    name: a.name,
                    ports: a.port ? [a.port] : [],
                    status: (a.mode === 'live' || a.mode === 'active') ? 'running' : (a.mode === 'readonly' ? 'mock' : 'unknown'),
                    isAgent: true,
                    icon: a.icon || 'ü§ñ'
                }));
                const allItems = [...projects, ...agentCards];
                const live = server.live || {};
                const diskPct = live.disk_pct || '-';
                const memUsed = live.mem_used || '-';
                const memTotal = live.mem_total || '-';
                
                const projectsHtml = allItems.map(p => {
                    const portStr = Array.isArray(p.ports) ? p.ports.join(', ') : (p.port || '-');
                    const statusClass = (p.status === 'running' || p.status === 'ok') ? 'running' : 
                                        (p.status === 'stopped' ? 'stopped' : 'unknown');
                    return `
                        <a href="${p.isAgent ? `/agent/${p.id}` : `/projects/${p.id}`}" class="project-card">
                            <div class="project-name">
                                <span class="project-status ${statusClass}"></span>
                                ${p.name}
                            </div>
                            <div class="project-port">Port: ${portStr}</div>
                        </a>
                    `;
                }).join('');
                
                return `
                    <div class="server-card">
                        <a href="/servers/${server.id}" class="server-header">
                            <span class="server-icon">${server.icon || 'üíª'}</span>
                            <div class="server-info">
                                <div class="server-name">${server.hostname} (.${server.ip.split('.').pop()})</div>
                                <div class="server-meta">${server.ssh_user}@ | ${server.os || 'Ubuntu'} | Disk: ${diskPct}% | RAM: ${memUsed}/${memTotal}MB</div>
                            </div>
                            <span class="server-status status-online">ONLINE</span>
                        </a>
                        <div class="server-body">
                            <div class="projects-grid">
                                ${projectsHtml || '<span style="color:#64748b">No projects</span>'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('servers-container').innerHTML = serversHtml;
            
            // Decommissioned servers
            const decomHtml = data.decommissioned.map(server => `
                <div class="server-card decom-card">
                    <div class="server-header">
                        <span class="server-icon">üí§</span>
                        <div class="server-info">
                            <div class="server-name">${server.hostname} (.${server.ip.split('.').pop()})</div>
                            <div class="server-meta">${server.ssh_user}@ | ${server.role || 'Decommissioned'}</div>
                        </div>
                        <span class="server-status status-decom">DECOM</span>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('decom-body').innerHTML = decomHtml;
            
            // Timestamp
            document.getElementById('last-updated').textContent = 'Last updated: ' + new Date().toLocaleString();
        } catch (e) {
            console.error('Fleet load failed:', e);
            document.getElementById('servers-container').innerHTML = '<p style="color:#f87171">Failed to load fleet data</p>';
        }
    }
    
    // Collapse toggle
    document.getElementById('decom-header').addEventListener('click', function() {
        this.classList.toggle('open');
        document.getElementById('decom-body').classList.toggle('open');
    });
    
    initCacheFirst('homebase_fleet', 'servers-container', loadFleet, 60000);
    </script>
</body>
</html>
