<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/svg+xml" href="/img/homebase.svg">
    <link rel="icon" type="image/x-icon" href="/img/homebase.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/img/homebase-180.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Tracker | Homebase</title>
                    <a href="/research">ðŸ”¬ Research</a>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #e2e8f0; min-height: 100vh; }
.main-nav { display: flex; align-items: center; padding: 0.75rem 1.5rem; background: #1e293b; border-bottom: 1px solid #334155; position: sticky; top: 0; z-index: 100; }
.main-nav .logo { font-size: 1.1rem; font-weight: 600; color: #e2e8f0; margin-right: 2rem; text-decoration: none; }
.main-nav .nav-links { display: flex; gap: 0.25rem; flex: 1; flex-wrap: wrap; align-items: center; }
.main-nav .nav-links a { color: #94a3b8; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-size: 0.875rem; text-decoration: none; transition: all 0.15s; }
.main-nav .nav-links a:hover, .main-nav .nav-links a.active { color: #e2e8f0; background: #334155; }

a { color: #60a5fa; text-decoration: none; }
a:hover { color: #93c5fd; }

.main-nav 

.page-container { padding: 1.5rem; max-width: 1400px; margin: 0 auto; }
.page-header { margin-bottom: 1rem; }
.page-header h1 { font-size: 1.75rem; font-weight: 600; margin-bottom: 0.25rem; }
.page-header p { color: #64748b; font-size: 0.875rem; }
.summary { display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.75rem; margin-bottom: 1rem; }
.card { padding: 0.75rem; border-radius: 0.5rem; text-align: center; background: #1e293b; border: 1px solid #334155; }
.card .num { font-size: 1.5rem; font-weight: 700; }
.card .lbl { color: #94a3b8; font-size: 0.7rem; }
.filters { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
.flt { padding: 0.35rem 0.75rem; border-radius: 0.25rem; border: 1px solid #475569; background: transparent; color: #94a3b8; cursor: pointer; font-size: 0.8rem; }
.flt:hover, .flt.active { background: #334155; color: #fff; border-color: #60a5fa; }
.project { margin-bottom: 1rem; background: #1e293b; border: 1px solid #334155; border-radius: 0.5rem; overflow: hidden; }
.proj-head { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid #334155; }
.proj-head:hover { background: #263148; }
.proj-title { font-weight: 600; }
.items { max-height: 5000px; overflow: hidden; }
.item { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem; border-bottom: 1px solid #1e293b; font-size: 0.85rem; background: #0f172a; }
.item:hover { background: #1a2332; }
.check { width: 1.2rem; height: 1.2rem; border-radius: 0.25rem; border: 2px solid #475569; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 0.7rem; }
.check.done { background: #16a34a; border-color: #16a34a; color: #fff; }
.check.blocked { background: #dc2626; border-color: #dc2626; color: #fff; }
.pri { padding: 0.1rem 0.4rem; border-radius: 0.2rem; font-size: 0.65rem; font-weight: 700; min-width: 1.8rem; text-align: center; }
.pri-P0 { background: #7f1d1d; color: #fca5a5; }
.pri-P1 { background: #78350f; color: #fde68a; }
.pri-P2 { background: #1e3a5f; color: #93c5fd; }
.pri-P3 { background: #1e293b; color: #94a3b8; }
.item-title { flex: 1; }
.done-text { text-decoration: line-through; color: #64748b; }
.auto { background: #4c1d95; color: #c4b5fd; padding: 0.1rem 0.4rem; border-radius: 0.2rem; font-size: 0.6rem; }
.notes { color: #64748b; font-size: 0.75rem; max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.sel { background: #1e293b; color: #e2e8f0; border: 1px solid #475569; padding: 0.2rem; border-radius: 0.2rem; font-size: 0.7rem; cursor: pointer; }
.progress { height: 4px; background: #334155; border-radius: 2px; margin-top: 0.5rem; }
.progress-bar { height: 100%; background: #4ade80; border-radius: 2px; }
@media (max-width: 768px) {
    .page-container { padding: 1rem; }
    .summary { grid-template-columns: repeat(3, 1fr); }
}
    </style>
</head>
<body>
    <nav class="main-nav">
    <a href="/" class="logo">Homebase</a>
    <div class="nav-links">
        <a href="/">Dashboard</a>
        <a href="/fleet">Fleet</a>
        <a href="/agents">Agents</a>
        <a href="/sentinel">Sentinel</a>
            <a href="/cortex">Cortex</a>
        <a href="/research">Research</a>
        <a href="/infra">Infra Sheet</a>
        <a href="/settings">Settings</a>
        <a href="/backups">Backups</a>
        <a href="/requirements">Requirements</a>
        <a href="https://gitea.rize.bm" target="_blank">Gitea</a>
    </div>
</nav>

    <div class="page-container">
        <div class="page-header">
            <h1>ðŸ“‹ Audit Fix Tracker</h1>
            <p>Track security and compliance fixes across all projects</p>
        </div>

        <div class="summary">
            <div class="card"><div class="num" id="sT" style="color:#60a5fa">-</div><div class="lbl">Total</div></div>
            <div class="card"><div class="num" id="sO" style="color:#fbbf24">-</div><div class="lbl">Open</div></div>
            <div class="card"><div class="num" id="sD" style="color:#4ade80">-</div><div class="lbl">Done</div></div>
            <div class="card"><div class="num" id="sB" style="color:#f87171">-</div><div class="lbl">Blocked</div></div>
            <div class="card"><div class="num" id="sA" style="color:#a78bfa">-</div><div class="lbl">âš¡ Auto</div></div>
            <div class="card"><div class="num" id="sP" style="color:#ef4444">-</div><div class="lbl">P0</div></div>
        </div>

        <div class="filters">
            <button class="flt active" onclick="setF('all',this)">All</button>
            <button class="flt" onclick="setF('open',this)">Open</button>
            <button class="flt" onclick="setF('done',this)">Done</button>
            <button class="flt" onclick="setF('blocked',this)">Blocked</button>
            <button class="flt" onclick="setF('P0',this)">P0</button>
            <button class="flt" onclick="setF('P1',this)">P1</button>
            <button class="flt" onclick="setF('auto',this)">âš¡ Auto</button>
        </div>

        <div id="list">
            <div style="color:#64748b;padding:2rem;text-align:center">Loading...</div>
        </div>
    </div>

    <script src="/static/cache-helper.js"></script>
<script>
var D = null, F = 'all';

function setF(f, b) {
    F = f;
    document.querySelectorAll('.flt').forEach(function(x) { x.classList.remove('active'); });
    if (b) b.classList.add('active');
    render();
}

async function tog(p, id, st) {
    var n = st === 'done' ? 'open' : 'done';
    await fetch('/api/audit-fixes/' + p + '/' + id + '/status', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({status: n})
    });
    load();
}

async function chg(p, id, v) {
    await fetch('/api/audit-fixes/' + p + '/' + id + '/status', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({status: v})
    });
    load();
}

function render() {
    if (!D) return;
    var P = D.projects;
    var h = '', t = {t: 0, o: 0, d: 0, b: 0, a: 0, p: 0};

    for (var k in P) {
        var p = P[k];
        var it = p.items;
        t.t += it.length;
        t.o += it.filter(function(i) { return i.status === 'open'; }).length;
        t.d += it.filter(function(i) { return i.status === 'done'; }).length;
        t.b += it.filter(function(i) { return i.status === 'blocked'; }).length;
        t.a += it.filter(function(i) { return i.automated; }).length;
        t.p += it.filter(function(i) { return i.priority === 'P0'; }).length;

        var fi = it;
        if (F === 'open') fi = it.filter(function(i) { return i.status === 'open'; });
        else if (F === 'done') fi = it.filter(function(i) { return i.status === 'done'; });
        else if (F === 'blocked') fi = it.filter(function(i) { return i.status === 'blocked'; });
        else if (F === 'P0') fi = it.filter(function(i) { return i.priority === 'P0'; });
        else if (F === 'P1') fi = it.filter(function(i) { return i.priority === 'P1'; });
        else if (F === 'auto') fi = it.filter(function(i) { return i.automated; });

        if (!fi.length && F !== 'all') continue;

        var dn = it.filter(function(i) { return i.status === 'done'; }).length;
        var pc = it.length ? Math.round(dn / it.length * 100) : 0;

        h += '<div class="project"><div class="proj-head" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display===\'none\'?\'block\':\'none\'">';
        h += '<div><span class="proj-title">' + p.icon + ' ' + p.name + ' <span style="color:#64748b;font-size:.8rem">(' + p.host + ')</span></span>';
        h += '<div class="progress"><div class="progress-bar" style="width:' + pc + '%"></div></div></div>';
        h += '<span style="color:#94a3b8;font-size:.8rem">' + dn + '/' + it.length + '</span></div><div class="items">';

        for (var j = 0; j < fi.length; j++) {
            var i = fi[j];
            var cc = i.status === 'done' ? 'done' : i.status === 'blocked' ? 'blocked' : '';
            var ci = i.status === 'done' ? 'âœ“' : i.status === 'blocked' ? 'âœ•' : '';
            var tc = i.status === 'done' ? 'done-text' : '';
            h += '<div class="item">';
            h += '<div class="check ' + cc + '" onclick="tog(\'' + k + "','" + i.id + "','" + i.status + '\')">' + ci + '</div>';
            h += '<span class="pri pri-' + i.priority + '">' + i.priority + '</span>';
            h += '<span class="item-title ' + tc + '">' + i.title + '</span>';
            if (i.automated) h += '<span class="auto">âš¡ auto</span>';
            h += '<select class="sel" onchange="chg(\'' + k + '\',\'' + i.id + '\',this.value)">';
            h += '<option value="open"' + (i.status === 'open' ? ' selected' : '') + '>Open</option>';
            h += '<option value="done"' + (i.status === 'done' ? ' selected' : '') + '>Done</option>';
            h += '<option value="blocked"' + (i.status === 'blocked' ? ' selected' : '') + '>Blocked</option></select>';
            if (i.notes) h += '<span class="notes" title="' + i.notes + '">' + i.notes + '</span>';
            h += '</div>';
        }
        h += '</div></div>';
    }

    document.getElementById('list').innerHTML = h;
    document.getElementById('sT').textContent = t.t;
    document.getElementById('sO').textContent = t.o;
    document.getElementById('sD').textContent = t.d;
    document.getElementById('sB').textContent = t.b;
    document.getElementById('sA').textContent = t.a;
    document.getElementById('sP').textContent = t.p;
}

async function load() {
    try {
        D = await fetch('/api/audit-fixes').then(function(r) { return r.json(); });
        render();
    } catch (e) {
        document.getElementById('list').innerHTML = '<div style="color:#f87171;padding:2rem">Error: ' + e.message + '</div>';
    }
}

initCacheFirst('homebase_audit', 'list', load, 60000);
    </script>
<footer style="text-align:center;padding:1rem;color:#475569;font-size:0.75rem;border-top:1px solid #1e293b;margin-top:2rem">Homebase v1.2.0 Â· Rize Technologies Â· <span id="ft-time"></span></footer>
<script>document.getElementById("ft-time")&&(document.getElementById("ft-time").textContent="Updated: "+new Date().toLocaleString())</script>
</body>
</html>
