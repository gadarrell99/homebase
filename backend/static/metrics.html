<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/svg+xml" href="/img/homebase.svg">
    <link rel="icon" type="image/x-icon" href="/img/homebase.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/img/homebase-180.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metrics | Homebase</title>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #e2e8f0; min-height: 100vh; }
.main-nav { display: flex; align-items: center; padding: 0.75rem 1.5rem; background: #1e293b; border-bottom: 1px solid #334155; position: sticky; top: 0; z-index: 100; }
.main-nav .logo { font-size: 1.1rem; font-weight: 600; color: #e2e8f0; margin-right: 2rem; text-decoration: none; }
.main-nav .nav-links { display: flex; gap: 0.25rem; flex: 1; flex-wrap: wrap; align-items: center; }
.main-nav .nav-links a { color: #94a3b8; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-size: 0.875rem; text-decoration: none; transition: all 0.15s; }
.main-nav .nav-links a:hover, .main-nav .nav-links a.active { color: #e2e8f0; background: #334155; }

a { color: #60a5fa; text-decoration: none; }
a:hover { color: #93c5fd; }

.page-container { padding: 1.5rem; max-width: 1400px; margin: 0 auto; }
.page-header { margin-bottom: 1.5rem; }
.page-header h1 { font-size: 1.75rem; font-weight: 600; margin-bottom: 0.25rem; }
.page-header p { color: #64748b; font-size: 0.875rem; }
.tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid #334155; padding-bottom: 0.75rem; }
.tab { padding: 0.6rem 1.25rem; border-radius: 0.375rem; border: none; background: transparent; color: #94a3b8; cursor: pointer; font-size: 0.875rem; font-weight: 500; transition: all 0.15s; }
.tab:hover { color: #f8fafc; background: #334155; }
.tab.active { color: #f8fafc; background: #3b82f6; }
.tab-content { display: none; }
.tab-content.active { display: block; }
.summary-row { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem; }
.summary-item { background: #1e293b; border: 1px solid #334155; border-radius: 0.5rem; padding: 0.75rem 1rem; text-align: center; min-width: 120px; }
.summary-item .num { font-size: 1.5rem; font-weight: 700; }
.summary-item .lbl { color: #94a3b8; font-size: 0.7rem; }
table { width: 100%; border-collapse: collapse; background: #1e293b; border-radius: 0.5rem; overflow: hidden; }
th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #334155; }
th { background: #0f172a; color: #94a3b8; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
td { font-size: 0.85rem; }
tr:hover { background: #1e3a5f; }
.status { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 1rem; font-size: 0.65rem; font-weight: 600; }
.status-ok, .status-online { background: #166534; color: #86efac; }
.status-warning { background: #854d0e; color: #fde047; }
.status-critical, .status-offline { background: #991b1b; color: #fca5a5; }
.mono { font-family: monospace; color: #94a3b8; }
@media (max-width: 768px) {
    .page-container { padding: 1rem; }
    table { display: block; overflow-x: auto; }
}
</style>
</head>
<body>
    <nav class="main-nav">
    <a href="/" class="logo">Homebase</a>
    <div class="nav-links">
        <a href="/">Dashboard</a>
        <a href="/fleet">Fleet</a>
        <a href="/agents">Agents</a>
        <a href="/sentinel">Sentinel</a>
            <a href="/cortex">Cortex</a>
        <a href="/research">Research</a>
        <a href="/infra">Infra Sheet</a>
        <a href="/settings">Settings</a>
        <a href="/backups">Backups</a>
        <a href="/requirements">Requirements</a>
        <a href="https://gitea.rize.bm" target="_blank">Gitea</a>
    </div>
</nav>

    <div class="page-container">
        <div class="page-header">
            <h1>ðŸ“Š Metrics</h1>
            <p>Live infrastructure metrics from infrastructure.json</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('servers', this)">ðŸ“¡ Servers</button>
            <button class="tab" onclick="switchTab('projects', this)">ðŸ“¦ Projects</button>
            <button class="tab" onclick="switchTab('agents', this)">ðŸ¤– Agents</button>
        </div>

        <!-- Server Metrics Tab -->
        <div id="servers-tab" class="tab-content active">
            <div class="summary-row">
                <div class="summary-item"><div class="num" id="server-total" style="color:#60a5fa">-</div><div class="lbl">Total Servers</div></div>
                <div class="summary-item"><div class="num" id="server-active" style="color:#4ade80">-</div><div class="lbl">Active</div></div>
                <div class="summary-item"><div class="num" id="server-decomm" style="color:#f87171">-</div><div class="lbl">Decommissioned</div></div>
                <div class="summary-item"><div class="num" id="avg-cpu" style="color:#a78bfa">-</div><div class="lbl">Avg CPU</div></div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Server</th>
                        <th>IP</th>
                        <th>Status</th>
                        <th>CPU</th>
                        <th>Memory</th>
                        <th>Disk</th>
                        <th>SSH</th>
                    </tr>
                </thead>
                <tbody id="server-tbody">
                    <tr><td colspan="7" style="color:#64748b;text-align:center">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Project Metrics Tab -->
        <div id="projects-tab" class="tab-content">
            <div class="summary-row">
                <div class="summary-item"><div class="num" id="project-total" style="color:#60a5fa">-</div><div class="lbl">Total Projects</div></div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Project</th>
                        <th>Server</th>
                        <th>Port</th>
                        <th>Domain</th>
                    </tr>
                </thead>
                <tbody id="project-tbody">
                    <tr><td colspan="4" style="color:#64748b;text-align:center">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Agent Metrics Tab -->
        <div id="agents-tab" class="tab-content">
            <div class="summary-row">
                <div class="summary-item"><div class="num" id="agent-total" style="color:#60a5fa">-</div><div class="lbl">Total Agents</div></div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Agent</th>
                        <th>Server</th>
                        <th>Mode</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody id="agent-tbody">
                    <tr><td colspan="4" style="color:#64748b;text-align:center">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>

    // === PRE-CACHE PATTERN ===
    const CACHE_KEY = "homebase_metrics_cache";
    const CACHE_TTL = 300000; // 5 minutes
    
    function getCached() {
        try {
            const raw = sessionStorage.getItem(CACHE_KEY);
            if (!raw) return null;
            const { data, ts } = JSON.parse(raw);
            if (Date.now() - ts > CACHE_TTL) return null;
            return data;
        } catch { return null; }
    }
    
    function setCache(data) {
        try {
            sessionStorage.setItem(CACHE_KEY, JSON.stringify({ data, ts: Date.now() }));
        } catch {}
    }
    
    function showRefreshing(show) {
        let indicator = document.getElementById("refresh-indicator");
        if (!indicator) {
            indicator = document.createElement("div");
            indicator.id = "refresh-indicator";
            indicator.style.cssText = "position:fixed;top:70px;right:20px;background:#1e293b;color:#60a5fa;padding:8px 16px;border-radius:6px;font-size:12px;z-index:1000;display:none;";
            indicator.textContent = "ðŸ”„ Refreshing...";
            document.body.appendChild(indicator);
        }
        indicator.style.display = show ? "block" : "none";
    }
    // === END PRE-CACHE PATTERN ===
function switchTab(tab, btn) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(tab + '-tab').classList.add('active');
    window.location.hash = tab;
}

let infraData = null;

async function loadInfrastructure() {
    try {
        const res = await fetch('/api/infrastructure');
        infraData = await res.json();
        renderServers();
        renderProjects();
        renderAgents();
    } catch (e) {
        document.getElementById('server-tbody').innerHTML = '<tr><td colspan="7" style="color:#f87171">Error: ' + e.message + '</td></tr>';
    }
}

function renderServers() {
    if (!infraData || !infraData.servers) return;
    
    const activeServers = infraData.servers.filter(s => s.status !== 'decommissioned');
    const decommServers = infraData.servers.filter(s => s.status === 'decommissioned');
    
    document.getElementById('server-total').textContent = infraData.servers.length;
    document.getElementById('server-active').textContent = activeServers.length;
    document.getElementById('server-decomm').textContent = decommServers.length;
    
    // Calculate avg CPU from active servers with live metrics
    let cpuSum = 0, cpuCount = 0;
    activeServers.forEach(s => {
        if (s.live && s.live.load) {
            cpuSum += parseFloat(s.live.load) * 100;
            cpuCount++;
        }
    });
    document.getElementById('avg-cpu').textContent = cpuCount > 0 ? Math.round(cpuSum / cpuCount) + '%' : '-';
    
    let html = '';
    
    // Active servers first
    activeServers.forEach(s => {
        const cpu = s.live && s.live.load ? (parseFloat(s.live.load) * 100).toFixed(0) + '%' : '-';
        const mem = s.live && s.live.mem_used && s.live.mem_total ? 
            Math.round(s.live.mem_used / s.live.mem_total * 100) + '%' : '-';
        const disk = s.live && s.live.disk_pct ? s.live.disk_pct + '%' : '-';
        const sshCmd = s.ssh_user ? s.ssh_user + '@' + s.ip : s.ip;
        
        html += '<tr>' +
            '<td><a href="/servers#' + s.id + '"><strong>' + s.hostname + '</strong></a></td>' +
            '<td class="mono">' + s.ip + '</td>' +
            '<td><span class="status status-online">Active</span></td>' +
            '<td>' + cpu + '</td>' +
            '<td>' + mem + '</td>' +
            '<td>' + disk + '</td>' +
            '<td><code class="mono" style="font-size:0.7rem">' + sshCmd + '</code></td>' +
            '</tr>';
    });
    
    // Decommissioned servers
    decommServers.forEach(s => {
        html += '<tr style="opacity:0.5">' +
            '<td><strong>' + s.hostname + '</strong></td>' +
            '<td class="mono">' + s.ip + '</td>' +
            '<td><span class="status status-offline">Decomm</span></td>' +
            '<td>-</td>' +
            '<td>-</td>' +
            '<td>-</td>' +
            '<td><em style="color:#64748b">Migrated to ' + s.migrated_to + '</em></td>' +
            '</tr>';
    });
    
    document.getElementById('server-tbody').innerHTML = html;
}

function renderProjects() {
    if (!infraData || !infraData.projects) return;
    
    document.getElementById('project-total').textContent = infraData.projects.length;
    
    let html = '';
    infraData.projects.forEach(p => {
        const serverLink = '<a href="/servers#' + p.server + '">' + p.server + '</a>';
        const ports = p.ports && p.ports.length ? p.ports.join(', ') : '-';
        const domain = p.domain ? '<a href="https://' + p.domain + '" target="_blank">' + p.domain + '</a>' : '-';
        
        html += '<tr>' +
            '<td><strong>' + p.name + '</strong></td>' +
            '<td>' + serverLink + '</td>' +
            '<td class="mono">' + ports + '</td>' +
            '<td>' + domain + '</td>' +
            '</tr>';
    });
    
    document.getElementById('project-tbody').innerHTML = html;
}

function renderAgents() {
    if (!infraData || !infraData.agents) return;
    
    document.getElementById('agent-total').textContent = infraData.agents.length;
    
    let html = '';
    infraData.agents.forEach(a => {
        const serverLink = '<a href="/servers#' + a.server + '">' + a.server + '</a>';
        const modeClass = a.mode === 'live' || a.mode === 'active' ? 'status-online' : 'status-warning';
        
        html += '<tr>' +
            '<td><strong>' + a.name + '</strong></td>' +
            '<td>' + serverLink + '</td>' +
            '<td><span class="status ' + modeClass + '">' + a.mode + '</span></td>' +
            '<td>' + a.description + '</td>' +
            '</tr>';
    });
    
    document.getElementById('agent-tbody').innerHTML = html;
}

// Check URL hash for initial tab
if (window.location.hash) {
    const tab = window.location.hash.replace('#', '');
    const btn = document.querySelector('.tab[onclick*="' + tab + '"]');
    if (btn) switchTab(tab, btn);
}

loadInfrastructure();
setInterval(loadInfrastructure, 60000);
    </script>
<footer style="text-align:center;padding:1rem;color:#475569;font-size:0.75rem;border-top:1px solid #1e293b;margin-top:2rem">Homebase v1.2.0 Â· Rize Technologies Â· <span id="ft-time"></span></footer>
<script>document.getElementById("ft-time").textContent="Updated: "+new Date().toLocaleString()</script>
</body>
</html>
