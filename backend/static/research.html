<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research | Homebase</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè†</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #e2e8f0; min-height: 100vh; }
.main-nav { display: flex; align-items: center; padding: 0.75rem 1.5rem; background: #1e293b; border-bottom: 1px solid #334155; position: sticky; top: 0; z-index: 100; }
.main-nav .logo { font-size: 1.1rem; font-weight: 600; color: #e2e8f0; margin-right: 2rem; text-decoration: none; }
.main-nav .nav-links { display: flex; gap: 0.25rem; flex: 1; flex-wrap: wrap; align-items: center; }
.main-nav .nav-links a { color: #94a3b8; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-size: 0.875rem; text-decoration: none; transition: all 0.15s; }
.main-nav .nav-links a:hover, .main-nav .nav-links a.active { color: #e2e8f0; background: #334155; }

        
        
        .nav-links { display: flex; gap: 1.5rem; }
        .nav-links a { color: #94a3b8; text-decoration: none; }
        .nav-links a:hover, .nav-links a.active { color: #60a5fa; }
        .container { max-width: 1100px; margin: 2rem auto; padding: 0 1rem; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .btn { background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 1rem; }
        .btn:hover { background: #2563eb; }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.85rem; }
        .btn-success { background: #22c55e; }
        .btn-danger { background: #ef4444; }
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem; }
        .stat { background: #1e293b; padding: 1.5rem; border-radius: 0.5rem; text-align: center; border: 1px solid #334155; }
        .stat-value { font-size: 2rem; font-weight: bold; color: #60a5fa; }
        .stat-label { color: #94a3b8; margin-top: 0.5rem; }
        .tabs { display: flex; gap: 1rem; margin-bottom: 1.5rem; border-bottom: 1px solid #334155; padding-bottom: 1rem; }
        .tab { background: none; border: none; color: #94a3b8; padding: 0.5rem 1rem; cursor: pointer; font-size: 1rem; }
        .tab.active { color: #60a5fa; border-bottom: 2px solid #60a5fa; }
        .item { background: #1e293b; padding: 1.25rem; border-radius: 0.5rem; margin-bottom: 1rem; border: 1px solid #334155; }
        .item-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; }
        .item-title { font-weight: 600; color: #e2e8f0; }
        .item-title a { color: #60a5fa; text-decoration: none; }
        .item-title a:hover { text-decoration: underline; }
        .item-meta { font-size: 0.85rem; color: #64748b; margin-bottom: 0.5rem; }
        .item-summary { color: #94a3b8; font-size: 0.9rem; line-height: 1.5; }
        .score { background: #3b82f6; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.8rem; font-weight: bold; }
        .score.high { background: #22c55e; }
        .actions { display: flex; gap: 0.5rem; margin-top: 1rem; }
        .loading { text-align: center; padding: 2rem; color: #64748b; }
    /* Unified Navigation */

.main-nav 

@media (max-width: 900px) {   }

</style>
</head>
<body>
    <nav class="main-nav">
    <a href="/" class="logo">Homebase</a>
    <div class="nav-links">
        <a href="/">Dashboard</a>
        <a href="/fleet">Fleet</a>
        <a href="/agents">Agents</a>
        <a href="/sentinel">Sentinel</a>
        <a href="/research" class="active">Research</a>
        <a href="/infra">Infra Sheet</a>
        <a href="/settings">Settings</a>
        <a href="/backups">Backups</a>
    </div>
</nav>
    
    <div class="container">
        <div class="header">
            <h1>Research Scout</h1>
            <button class="btn" onclick="runScan()">Run Scan Now</button>
        </div>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="stat-new">-</div>
                <div class="stat-label">New Items</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-reviewed">-</div>
                <div class="stat-label">Reviewed</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-implemented">-</div>
                <div class="stat-label">Implemented</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="loadItems('new')">New</button>
            <button class="tab" onclick="loadItems('reviewed')">Reviewed</button>
            <button class="tab" onclick="loadItems('implemented')">Implemented</button>
            <button class="tab" onclick="loadItems('dismissed')">Dismissed</button>
        </div>

        <div id="items" class="items">
            <div class="loading">Loading...</div>
        </div>
    </div>
    <script>

    // === PRE-CACHE PATTERN ===
    const CACHE_KEY = "homebase_research_cache";
    const CACHE_TTL = 300000; // 5 minutes
    
    function getCached() {
        try {
            const raw = sessionStorage.getItem(CACHE_KEY);
            if (!raw) return null;
            const { data, ts } = JSON.parse(raw);
            if (Date.now() - ts > CACHE_TTL) return null;
            return data;
        } catch { return null; }
    }
    
    function setCache(data) {
        try {
            sessionStorage.setItem(CACHE_KEY, JSON.stringify({ data, ts: Date.now() }));
        } catch {}
    }
    
    function showRefreshing(show) {
        let indicator = document.getElementById("refresh-indicator");
        if (!indicator) {
            indicator = document.createElement("div");
            indicator.id = "refresh-indicator";
            indicator.style.cssText = "position:fixed;top:70px;right:20px;background:#1e293b;color:#60a5fa;padding:8px 16px;border-radius:6px;font-size:12px;z-index:1000;display:none;";
            indicator.textContent = "üîÑ Refreshing...";
            document.body.appendChild(indicator);
        }
        indicator.style.display = show ? "block" : "none";
    }
    // === END PRE-CACHE PATTERN ===
        let currentStatus = 'new';
        
        async function loadStats() {
            const counts = {};
            for (const s of ['new', 'reviewed', 'implemented', 'dismissed']) {
                const r = await fetch('/api/research?status=' + s + '&limit=1000');
                const items = await r.json();
                counts[s] = items.length;
            }
            document.getElementById('stat-new').textContent = counts.new || 0;
            document.getElementById('stat-reviewed').textContent = counts.reviewed || 0;
            document.getElementById('stat-implemented').textContent = counts.implemented || 0;
        }
        
        async function loadItems(status, evt) {
            currentStatus = status;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => {
                if (t.textContent.toLowerCase().includes(status)) t.classList.add('active');
            });
            
            const container = document.getElementById('items');
            container.innerHTML = '<div class="loading">Loading...</div>';
            
            try {
                const resp = await fetch('/api/research?status=' + status);
                if (!resp.ok) throw new Error('API returned ' + resp.status);
                const items = await resp.json();
                
                if (!items || items.length === 0) {
                    container.innerHTML = '<div class="loading">No ' + status + ' items found</div>';
                    return;
                }
            
            container.innerHTML = items.map(item => {
                const scoreClass = item.relevance_score >= 30 ? 'high' : '';
                return '<div class="item">' +
                    '<div class="item-header">' +
                        '<div class="item-title"><a href="' + item.url + '" target="_blank">' + (item.title || 'Untitled') + '</a></div>' +
                        '<span class="score ' + scoreClass + '">' + item.relevance_score + '</span>' +
                    '</div>' +
                    '<div class="item-meta">' + item.source + ' ‚Ä¢ ' + (item.discovered_at || '').split('T')[0] + '</div>' +
                    '<div class="item-summary">' + (item.summary || '').substring(0, 300) + '</div>' +
                    '<div class="actions">' +
                        (status === 'new' ? '<button class="btn btn-sm btn-success" onclick="setStatus(' + item.id + ', &apos;reviewed&apos;)">Mark Reviewed</button>' : '') +
                        (status === 'reviewed' ? '<button class="btn btn-sm btn-success" onclick="setStatus(' + item.id + ', &apos;implemented&apos;)">Implemented</button>' : '') +
                        (status !== 'dismissed' ? '<button class="btn btn-sm btn-danger" onclick="setStatus(' + item.id + ', &apos;dismissed&apos;)">Dismiss</button>' : '') +
                    '</div>' +
                '</div>';
            }).join('');
            } catch (e) {
                console.error('Load items error:', e);
                container.innerHTML = '<div class="loading" style="color:#f87171">Error: ' + e.message + '</div>';
            }
        }
        
        async function setStatus(id, status) {
            await fetch('/api/research/' + id + '/status', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({status: status})
            });
            loadItems(currentStatus);
            loadStats();
        }
        
        async function runScan() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Scanning...';
            const resp = await fetch('/api/research/scan', {method: 'POST'});
            const result = await resp.json();
            btn.disabled = false;
            btn.textContent = 'Run Scan Now';
            alert('Scan complete: ' + result.saved + ' new items saved, ' + result.skipped + ' skipped');
            loadItems('new');
            loadStats();
        }
        
        try {
            loadItems('new');
            loadStats();
        } catch (e) {
            console.error('Page load error:', e);
            document.getElementById('items').innerHTML = '<div class="loading" style="color:#f87171">Error loading: ' + e.message + '</div>';
        }
    </script>
</body>
</html>
