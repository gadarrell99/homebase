<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Spend | Homebase</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ’°</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #e2e8f0; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; border-bottom: 1px solid #334155; margin-bottom: 30px; }
        h1 { font-size: 1.5rem; }
        .nav { display: flex; gap: 20px; }
        .nav a { color: #94a3b8; text-decoration: none; }
        .nav a:hover { color: #e2e8f0; }
        .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: #1e293b; border-radius: 12px; padding: 20px; }
        .card-label { color: #94a3b8; font-size: 0.875rem; margin-bottom: 8px; }
        .card-value { font-size: 1.75rem; font-weight: 600; }
        .card-value.cost { color: #22c55e; }
        table { width: 100%; border-collapse: collapse; background: #1e293b; border-radius: 12px; overflow: hidden; margin-bottom: 20px; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #334155; }
        th { background: #0f172a; color: #94a3b8; font-weight: 500; }
        tr:hover { background: #334155; }
        .section-title { font-size: 1.125rem; margin-bottom: 16px; color: #f8fafc; }
        .refresh-btn { background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; }
        .refresh-btn:hover { background: #2563eb; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }
        .timestamp { color: #64748b; font-size: 0.875rem; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ’° AI Spend Dashboard</h1>
            <nav class="nav">
                <a href="/">Dashboard</a>
                <a href="/agents">Agents</a>
                <a href="/sentinel">Sentinel</a>
                <a href="/settings">Settings</a>
            </nav>
        </header>
        
        <div id="ai-spend-content">
        <div class="cards">
            <div class="card">
                <div class="card-label">Total Cost (7 days)</div>
                <div class="card-value cost" id="total-cost">$0.00</div>
            </div>
            <div class="card">
                <div class="card-label">Total Calls</div>
                <div class="card-value" id="total-calls">0</div>
            </div>
            <div class="card">
                <div class="card-label">Today's Cost</div>
                <div class="card-value cost" id="today-cost">$0.00</div>
            </div>
            <div class="card">
                <div class="card-label">Avg Cost/Call</div>
                <div class="card-value" id="avg-cost">$0.00</div>
            </div>
        </div>
        
        <div class="grid-2">
            <div>
                <h3 class="section-title">By Agent</h3>
                <table id="agent-table">
                    <thead>
                        <tr><th>Agent</th><th>Calls</th><th>Cost</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div>
                <h3 class="section-title">By Model</h3>
                <table id="model-table">
                    <thead>
                        <tr><th>Model</th><th>Calls</th><th>Cost</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <h3 class="section-title">Daily Breakdown</h3>
        <table id="daily-table">
            <thead>
                <tr><th>Date</th><th>Calls</th><th>Input Tokens</th><th>Output Tokens</th><th>Cost</th></tr>
            </thead>
            <tbody></tbody>
        </table>
        
        <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
            <span class="timestamp" id="last-updated">Loading...</span>
            <button class="refresh-btn" onclick="loadData()">Refresh</button>
        </div>
    </div>
        </div>
    
    <script src="/static/cache-helper.js"></script>
<script>
        async function loadData() {
            try {
                const resp = await fetch('/api/ai-spend');
                const data = await resp.json();
                
                if (data.error) {
                    document.getElementById('last-updated').textContent = 'Error: ' + data.error;
                    return;
                }
                
                // Update cards
                document.getElementById('total-cost').textContent = '$' + (data.total_cost || 0).toFixed(4);
                document.getElementById('total-calls').textContent = data.total_calls || 0;
                
                const today = data.daily && data.daily[0];
                document.getElementById('today-cost').textContent = '$' + (today ? today.cost.toFixed(4) : '0.00');
                
                const avgCost = data.total_calls > 0 ? data.total_cost / data.total_calls : 0;
                document.getElementById('avg-cost').textContent = '$' + avgCost.toFixed(4);
                
                // Agent table
                const agentBody = document.querySelector('#agent-table tbody');
                agentBody.innerHTML = (data.by_agent || []).map(a => 
                    `<tr><td>${a.agent}</td><td>${a.calls}</td><td>$${a.cost.toFixed(4)}</td></tr>`
                ).join('');
                
                // Model table
                const modelBody = document.querySelector('#model-table tbody');
                modelBody.innerHTML = (data.by_model || []).map(m => 
                    `<tr><td>${m.model}</td><td>${m.calls}</td><td>$${m.cost.toFixed(4)}</td></tr>`
                ).join('');
                
                // Daily table
                const dailyBody = document.querySelector('#daily-table tbody');
                dailyBody.innerHTML = (data.daily || []).map(d => 
                    `<tr><td>${d.date}</td><td>${d.calls}</td><td>${d.input_tokens}</td><td>${d.output_tokens}</td><td>$${d.cost.toFixed(4)}</td></tr>`
                ).join('');
                
                document.getElementById('last-updated').textContent = 'Last updated: ' + (data.generated || 'unknown');
                
            } catch (e) {
                document.getElementById('last-updated').textContent = 'Error loading data: ' + e.message;
            }
        }
        
        initCacheFirst('homebase_ai_spend', 'ai-spend-content', loadData, 300000); // Refresh every 5 minutes
    </script>
</body>
</html>
