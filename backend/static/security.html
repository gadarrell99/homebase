<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/svg+xml" href="/img/homebase.svg">
    <link rel="icon" type="image/x-icon" href="/img/homebase.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/img/homebase-180.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security | Homebase</title>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #e2e8f0; min-height: 100vh; }
.main-nav { display: flex; align-items: center; padding: 0.75rem 1.5rem; background: #1e293b; border-bottom: 1px solid #334155; position: sticky; top: 0; z-index: 100; }
.main-nav .logo { font-size: 1.1rem; font-weight: 600; color: #e2e8f0; margin-right: 2rem; text-decoration: none; }
.main-nav .nav-links { display: flex; gap: 0.25rem; flex: 1; flex-wrap: wrap; align-items: center; }
.main-nav .nav-links a { color: #94a3b8; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-size: 0.875rem; text-decoration: none; transition: all 0.15s; }
.main-nav .nav-links a:hover, .main-nav .nav-links a.active { color: #e2e8f0; background: #334155; }

a { color: #60a5fa; text-decoration: none; }
a:hover { color: #93c5fd; }

.main-nav 

.page-container { padding: 1.5rem; max-width: 1400px; margin: 0 auto; }
.page-header { margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem; }
.page-header h1 { font-size: 1.75rem; font-weight: 600; margin-bottom: 0.25rem; }
.page-header p { color: #64748b; font-size: 0.875rem; }
.btn { display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.8rem; font-weight: 500; border: none; cursor: pointer; transition: all 0.15s; }
.btn-primary { background: #3b82f6; color: white; }
.btn-primary:hover { background: #2563eb; }
.section { margin-bottom: 2rem; }
.section-title { font-size: 1rem; color: #94a3b8; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
.score-card { background: #1e293b; border: 1px solid #334155; border-radius: 0.5rem; padding: 1.5rem; text-align: center; display: inline-block; margin-right: 1rem; margin-bottom: 1rem; }
.score-big { font-size: 3rem; font-weight: 700; }
.score-label { color: #94a3b8; font-size: 0.8rem; margin-top: 0.25rem; }
.score-green { color: #4ade80; }
.score-yellow { color: #fbbf24; }
.score-red { color: #f87171; }
.summary-row { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem; }
.summary-item { background: #1e293b; border: 1px solid #334155; border-radius: 0.5rem; padding: 0.75rem 1rem; text-align: center; min-width: 100px; }
.summary-item .num { font-size: 1.5rem; font-weight: 700; }
.summary-item .lbl { color: #94a3b8; font-size: 0.7rem; }
.server-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
.server-card { background: #1e293b; border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem; cursor: pointer; transition: all 0.15s; }
.server-card:hover { border-color: #475569; }
.server-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
.server-name { font-weight: 600; }
.server-ip { color: #64748b; font-size: 0.75rem; font-family: monospace; }
.server-score { font-size: 1.25rem; font-weight: 700; }
.checks { margin-top: 0.75rem; display: none; }
.server-card.expanded .checks { display: block; }
.check { display: flex; align-items: center; gap: 0.5rem; padding: 0.375rem 0; font-size: 0.8rem; border-bottom: 1px solid #334155; }
.check:last-child { border-bottom: none; }
.check-icon { width: 16px; text-align: center; }
.check-pass { color: #4ade80; }
.check-warn { color: #fbbf24; }
.check-fail { color: #f87171; }
.check-name { flex: 1; }
.check-detail { color: #64748b; font-size: 0.7rem; }
.quick-links { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
.quick-link { background: #1e293b; border: 1px solid #334155; border-radius: 0.5rem; padding: 1.25rem; transition: all 0.15s; }
.quick-link:hover { border-color: #475569; background: #1e3a5f; }
.quick-link .icon { font-size: 1.5rem; margin-bottom: 0.5rem; }
.quick-link .title { font-weight: 500; margin-bottom: 0.25rem; }
.quick-link .desc { font-size: 0.75rem; color: #64748b; }
.scan-info { color: #64748b; font-size: 0.8rem; margin-top: 0.5rem; }
@media (max-width: 768px) {
    .page-container { padding: 1rem; }
}
    </style>

<script>

    // === PRE-CACHE PATTERN ===
    const CACHE_KEY = "homebase_security_cache";
    const CACHE_TTL = 300000; // 5 minutes
    
    function getCached() {
        try {
            const raw = sessionStorage.getItem(CACHE_KEY);
            if (!raw) return null;
            const { data, ts } = JSON.parse(raw);
            if (Date.now() - ts > CACHE_TTL) return null;
            return data;
        } catch { return null; }
    }
    
    function setCache(data) {
        try {
            sessionStorage.setItem(CACHE_KEY, JSON.stringify({ data, ts: Date.now() }));
        } catch {}
    }
    
    function showRefreshing(show) {
        let indicator = document.getElementById("refresh-indicator");
        if (!indicator) {
            indicator = document.createElement("div");
            indicator.id = "refresh-indicator";
            indicator.style.cssText = "position:fixed;top:70px;right:20px;background:#1e293b;color:#60a5fa;padding:8px 16px;border-radius:6px;font-size:12px;z-index:1000;display:none;";
            indicator.textContent = "üîÑ Refreshing...";
            document.body.appendChild(indicator);
        }
        indicator.style.display = show ? "block" : "none";
    }
    // === END PRE-CACHE PATTERN ===
// Utility: safe display values
function safe(val, fallback) { return (val !== undefined && val !== null && val !== '') ? val : (fallback || 'N/A'); }
function scoreColor(score) {
    if (score === null || score === undefined) return '#64748b';
    if (score >= 80) return '#4ade80';
    if (score >= 60) return '#fbbf24';
    return '#f87171';
}
function statusIcon(s) { return s === 'pass' ? '‚úÖ' : s === 'fail' ? '‚ùå' : '‚ö†Ô∏è'; }
</script>

</head>
<body>
    <nav class="main-nav">
    <a href="/" class="logo">Homebase</a>
    <div class="nav-links">
        <a href="/">Dashboard</a>
        <a href="/fleet">Fleet</a>
        <a href="/agents">Agents</a>
        <a href="/sentinel">Sentinel</a>
            <a href="/cortex">Cortex</a>
        <a href="/research">Research</a>
        <a href="/infra">Infra Sheet</a>
        <a href="/settings">Settings</a>
        <a href="/backups">Backups</a>
        <a href="/requirements">Requirements</a>
        <a href="https://gitea.rize.bm" target="_blank">Gitea</a>
    </div>
</nav>

    <div class="page-container">
        <div class="page-header">
            <div>
                <h1>üõ°Ô∏è Security Dashboard</h1>
                <p>Cached nightly scan results across all servers</p>
                <div class="scan-info" id="scan-info">Loading scan data...</div>
            </div>
            <button class="btn btn-primary" id="scan-btn" onclick="triggerScan()">üîÑ Run Scan Now</button>
        </div>

        <!-- Overview Section -->
        <div class="section">
            <div style="display: flex; align-items: flex-start; flex-wrap: wrap; gap: 1rem;">
                <div class="score-card">
                    <div class="score-big" id="overall-score">--</div>
                    <div class="score-label">Security Score</div>
                </div>
                <div class="summary-row">
                    <div class="summary-item">
                        <div class="num" id="total-checks" style="color:#60a5fa">--</div>
                        <div class="lbl">Total Checks</div>
                    </div>
                    <div class="summary-item">
                        <div class="num" id="pass-count" style="color:#4ade80">--</div>
                        <div class="lbl">Pass</div>
                    </div>
                    <div class="summary-item">
                        <div class="num" id="warn-count" style="color:#fbbf24">--</div>
                        <div class="lbl">Warning</div>
                    </div>
                    <div class="summary-item">
                        <div class="num" id="fail-count" style="color:#f87171">--</div>
                        <div class="lbl">Failed</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Server Security Grid -->
        <div class="section">
            <h2 class="section-title">üì° Server Security Status</h2>
            <p style="color:#64748b;font-size:0.8rem;margin-bottom:1rem">Click a server to expand security checks</p>
            <div class="server-grid" id="server-grid">
                <div style="color:#64748b;padding:2rem;text-align:center">Loading security data...</div>
            </div>
        </div>

        <!-- Quick Links -->
        <div class="section">
            <h2 class="section-title">üîó Security Tools</h2>
            <div class="quick-links">
                <a href="/audit-tracker" class="quick-link">
                    <div class="icon">üìã</div>
                    <div class="title">Audit Tracker</div>
                    <div class="desc">Track security fixes across projects</div>
                </a>
            </div>
        </div>
    </div>

    <script>
var scanData = null;

function getScoreClass(score) {
    if (score >= 85) return 'score-green';
    if (score >= 70) return 'score-yellow';
    return 'score-red';
}

function formatDate(isoStr) {
    if (!isoStr) return 'Never';
    var d = new Date(isoStr);
    return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

function toggleServer(el) {
    el.classList.toggle('expanded');
}

function render() {
    if (!scanData) return;

    // Overall score
    var scoreEl = document.getElementById('overall-score');
    scoreEl.textContent = scanData.overall_score + '%';
    scoreEl.className = 'score-big ' + getScoreClass(scanData.overall_score);

    // Summary
    document.getElementById('total-checks').textContent = (scanData.summary||{}).total_checks||0;
    document.getElementById('pass-count').textContent = (scanData.summary||{}).pass||0;
    document.getElementById('warn-count').textContent = (scanData.summary||{}).warn||0;
    document.getElementById('fail-count').textContent = (scanData.summary||{}).fail||0;

    // Scan info
    document.getElementById('scan-info').textContent =
        'Last scan: ' + formatDate(scanData.last_scan) + ' ‚Ä¢ Next scan: ' + formatDate(scanData.next_scan);

    // Server grid
    var html = '';
    for (var serverId in scanData.servers) {
        var s = scanData.servers[serverId];
        var scoreClass = getScoreClass(s.score);

        var checksHtml = s.checks.map(function(c) {
            var icon = c.status === 'pass' ? '‚úì' : c.status === 'warn' ? '‚ö†' : '‚úï';
            var iconClass = 'check-' + c.status;
            return '<div class="check">' +
                '<span class="check-icon ' + iconClass + '">' + icon + '</span>' +
                '<span class="check-name">' + safe(c.name) + '</span>' +
                '<span class="check-detail">' + safe(c.detail) + '</span>' +
                '</div>';
        }).join('');

        html += '<div class="server-card" onclick="toggleServer(this)">' +
            '<div class="server-header">' +
            '<div><div class="server-name">' + safe(s.name, serverId) + '</div><div class="server-ip">' + safe(s.ip, '') + '</div></div>' +
            '<div class="server-score ' + scoreClass + '">' + s.score + '%</div>' +
            '</div>' +
            '<div class="checks">' + checksHtml + '</div>' +
            '</div>';
    }
    document.getElementById('server-grid').innerHTML = html;
}

async function load() {
    try {
        var res = await fetch('/api/security/scans');
        scanData = await res.json();
        render();
    } catch (e) {
        document.getElementById('server-grid').innerHTML = '<div style="color:#f87171;padding:2rem">Error loading security data: ' + e.message + '</div>';
    }
}

async function triggerScan() {
    var btn = document.getElementById('scan-btn');
    btn.textContent = '‚è≥ Scanning...';
    btn.disabled = true;

    try {
        await fetch('/api/security/scans/trigger', {method: 'POST'});
        setTimeout(function() {
            load();
            btn.textContent = 'üîÑ Run Scan Now';
            btn.disabled = false;
        }, 3000);
    } catch (e) {
        btn.textContent = 'üîÑ Run Scan Now';
        btn.disabled = false;
        alert('Scan trigger failed: ' + e.message);
    }
}

load();
setInterval(load, 60000);
    </script>
<footer style="text-align:center;padding:1rem;color:#475569;font-size:0.75rem;border-top:1px solid #1e293b;margin-top:2rem">Homebase v1.2.0 ¬∑ Rize Technologies ¬∑ <span id="ft-time"></span></footer>
<script>document.getElementById("ft-time")&&(document.getElementById("ft-time").textContent="Updated: "+new Date().toLocaleString())</script>
</body>
<div id="alerts-section" style="margin:1.5rem;padding:1rem;background:#0f172a;border-radius:8px">
  <h2 style="color:#e2e8f0;margin:0 0 1rem 0">üö® Active Alerts</h2>
  <div id="alerts-list" style="color:#94a3b8">Loading alerts...</div>
</div>
<script>
(async function loadAlerts(){
    try{
        const r=await fetch('/api/alerts?limit=50');
        const alerts=await r.json();
        const list=document.getElementById('alerts-list');
        if(!Array.isArray(alerts)||alerts.length===0){
            list.innerHTML='<div style="color:#4ade80;padding:0.5rem">‚úÖ No active alerts</div>';
            return;
        }
        let html='';
        const sevColors={critical:'#ef4444',warning:'#f59e0b',info:'#3b82f6'};
        const sevIcons={critical:'üî¥',warning:'üü°',info:'üîµ'};
        for(const a of alerts.slice(0,30)){
            const color=sevColors[a.severity]||'#64748b';
            const icon=sevIcons[a.severity]||'‚ö™';
            const ack=a.acknowledged?'opacity:0.5;':'';
            const time=new Date(a.timestamp).toLocaleString();
            html+='<div style="'+ack+'display:flex;align-items:center;gap:0.75rem;padding:0.6rem 0.75rem;margin:0.25rem 0;background:#1e293b;border-radius:6px;border-left:3px solid '+color+'">';
            html+='<span>'+icon+'</span>';
            html+='<div style="flex:1">';
            html+='<div style="color:#e2e8f0;font-size:0.9rem">'+safe(a.message)+'</div>';
            html+='<div style="color:#64748b;font-size:0.75rem">'+safe(a.source)+'/'+safe(a.target)+' ¬∑ '+time+'</div>';
            html+='</div>';
            if(!a.acknowledged){
                html+='<button onclick="ackAlert(\''+a.id+'\')" style="background:#334155;color:#94a3b8;border:none;padding:0.25rem 0.75rem;border-radius:4px;cursor:pointer;font-size:0.8rem">Ack</button>';
            }else{
                html+='<span style="color:#4ade80;font-size:0.75rem">‚úì</span>';
            }
            html+='</div>';
        }
        list.innerHTML=html;
    }catch(e){
        document.getElementById('alerts-list').innerHTML='<div style="color:#f87171">Failed to load alerts</div>';
    }
})();
async function ackAlert(id){
    await fetch('/api/alerts/'+id+'/acknowledge',{method:'POST'});
    location.reload();
}
</script>
</html>
